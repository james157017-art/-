/**
 * ========================================
 * Gemini AI ê¸°ë°˜ êµìœ¡ ì¶”ì²œ ì‹œìŠ¤í…œ v4.5
 * ========================================
 * * ì£¼ìš” ìˆ˜ì • ì‚¬í•­ (v4.5):
 * 1. ì½”ë“œ ìµœì í™” ë° ë¦¬íŒ©í† ë§
 *    - ì¤‘ë³µ ì½”ë“œ ì œê±° ë° í•¨ìˆ˜ í†µí•©
 *    - ìƒìˆ˜ ë° ì„¤ì • ê´€ë¦¬ ê°œì„ 
 *    - ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™”
 *    - ì„±ëŠ¥ ìµœì í™” (ìºì‹±, ë°°ì¹˜ ì²˜ë¦¬)
 * 2. ì½”ë“œ ê°€ë…ì„± í–¥ìƒ
 *    - ëª…í™•í•œ í•¨ìˆ˜ëª… ë° ì£¼ì„
 *    - ì¼ê´€ëœ ì½”ë”© ìŠ¤íƒ€ì¼
 * 3. ìœ ì§€ë³´ìˆ˜ì„± ê°œì„ 
 *    - ëª¨ë“ˆí™”ëœ êµ¬ì¡°
 *    - í™•ì¥ ê°€ëŠ¥í•œ ì„¤ê³„
 */

// ========================================
// 1. ì„¤ì • ë° ìƒìˆ˜
// ========================================
const CONFIG = {
  GEMINI_API_KEY: PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY'),
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemma-3-12b-it:generateContent',
  MAX_RETRIES: 5,
  BASE_DELAY: 1000,
  BATCH_SIZE: 3,
  PROCESS_DELAY: 5000,
  TOAST_DURATION: 3,
  
  SHEETS: {
    EMPLOYEE: 'ì§ì›ì •ë³´',
    TREND: 'íŠ¸ë Œë“œë¶„ì„',
    RESULT: 'ì¶”ì²œê²°ê³¼'
  },
  
  SHEET_HEADERS: {
    EMPLOYEE: ['ì„ íƒ', 'ì§ì›ID', 'ì´ë¦„', 'ì´ë©”ì¼', 'ì§ë¬´', 'ë¶€ì„œ', 'ê²½ë ¥(ë…„)', 'í˜„ì¬ ì—­ëŸ‰', 'ëª©í‘œ ì—­ëŸ‰', 'ì˜ˆì‚°(ë§Œì›)', 'ìƒíƒœ'],
    TREND: ['ë¶„ì„ì¼ì‹œ', 'ì§ì›ID', 'ì´ë¦„', 'ë¶€ì„œ', 'ì§ë¬´', 'í•µì‹¬ í‚¤ì›Œë“œ', 'ì¶”ì²œ í•™ìŠµ ì£¼ì œ'],
    RESULT: ['ì¶”ì²œì¼ì‹œ', 'ì§ì›ID', 'ì´ë¦„', 'ë¶€ì„œ', 'ì§ë¬´', 'í•µì‹¬ í‚¤ì›Œë“œ', 'ì¶”ì²œ ì£¼ì œ', 'ê²€ìƒ‰ í‚¤ì›Œë“œ', 'ê³¼ì • URL', 'YouTube ê²€ìƒ‰ì–´', 'YouTube URL']
  },
  
  EDUCATION_SITES: {
    'inflearn': { name: 'ì¸í”„ëŸ°', searchUrl: 'https://www.inflearn.com/courses?s=' },
    'udemy': { name: 'Udemy', searchUrl: 'https://www.udemy.com/courses/search/?q=' },
    'fastcampus': { name: 'íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤', searchUrl: 'https://fastcampus.co.kr/search?keyword=' },
    'coursera': { name: 'Coursera', searchUrl: 'https://www.coursera.org/search?query=' },
    'class101': { name: 'í´ë˜ìŠ¤101', searchUrl: 'https://class101.net/search?query=' },
    'kmooc': { name: 'K-MOOC', searchUrl: 'http://www.kmooc.kr/courses?search_query=' },
    'elice': { name: 'ì—˜ë¦¬ìŠ¤', searchUrl: 'https://elice.io/explore?query=' },
    'programmers': { name: 'í”„ë¡œê·¸ë˜ë¨¸ìŠ¤', searchUrl: 'https://school.programmers.co.kr/learn/courses?query=' },
    'goorm': { name: 'êµ¬ë¦„', searchUrl: 'https://edu.goorm.io/search?keyword=' },
    'sba': { name: 'SBAì•„ì¹´ë°ë¯¸', searchUrl: 'https://www.sbacademy.co.kr/search?keyword=' },
    'kmong': { name: 'í¬ëª½í´ë˜ìŠ¤', searchUrl: 'https://kmong.com/class/search?keyword=' },
    'linkedin': { name: 'LinkedIn Learning', searchUrl: 'https://www.linkedin.com/learning/search?keywords=' },
    'edx': { name: 'edX', searchUrl: 'https://www.edx.org/search?q=' }
  }
};

const CACHE = CacheService.getScriptCache();
const PROPS = PropertiesService.getScriptProperties();

// ========================================
// 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ========================================
const Utils = {
  log(category, message, data = null) {
    const timestamp = new Date().toISOString();
    let logMessage = `[${timestamp}] [${category}] ${message}`;
    if (data) {
      try {
        logMessage += '\n' + JSON.stringify(data, null, 2);
      } catch (e) {
        logMessage += '\n' + String(data);
      }
    }
    console.log(logMessage);
  },

  sleep(ms) {
    Utilities.sleep(ms);
  },

  showProgress(message, duration = CONFIG.TOAST_DURATION) {
    SpreadsheetApp.getActiveSpreadsheet().toast(message, 'ì§„í–‰ ì¤‘...', duration);
  },

  isValidUrl(url) {
    return url && typeof url === 'string' && /^https?:\/\/.+/i.test(url);
  },

  escapeHtml(text) {
    if (!text) return '';
    return text.toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  },

  extractJSON(text) {
    if (!text) return null;
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try {
        return JSON.parse(jsonMatch[0]);
      } catch (e) {
        this.log('JSON_PARSE_ERROR', 'Failed to parse JSON', e);
        return null;
      }
    }
    return null;
  },

  generateSearchUrl(siteKey, query) {
    const site = CONFIG.EDUCATION_SITES[siteKey.toLowerCase()];
    return site ? site.searchUrl + encodeURIComponent(query) : '';
  },

  validateUrl(url) {
    try {
      const response = UrlFetchApp.fetch(url, {
        muteHttpExceptions: true,
        followRedirects: true
      });
      return response.getResponseCode() === 200;
    } catch (e) {
      this.log('URL_VALIDATION_ERROR', 'Failed to validate URL', { url, error: e.message });
      return false;
    }
  },

  safeStringify(data) {
    if (Array.isArray(data)) {
      return data.map(item => typeof item === 'object' ? JSON.stringify(item) : String(item)).join('\n');
    }
    return String(data);
  }
};

// ========================================
// 3. API í˜¸ì¶œ ê´€ë¦¬
// ========================================
const APIManager = {
  callGemini(prompt, retryCount = 0) {
    try {
      const response = UrlFetchApp.fetch(
        `${CONFIG.GEMINI_API_URL}?key=${CONFIG.GEMINI_API_KEY}`,
        {
          method: 'post',
          contentType: 'application/json',
          muteHttpExceptions: true,
          payload: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 2048
            }
          })
        }
      );

      const responseCode = response.getResponseCode();
      
      if (responseCode === 200) {
        return JSON.parse(response.getContentText())
          ?.candidates?.[0]?.content?.parts?.[0]?.text;
      }

      if ((responseCode === 429 || responseCode === 503) && retryCount < CONFIG.MAX_RETRIES - 1) {
        Utils.sleep(CONFIG.BASE_DELAY * Math.pow(2, retryCount));
        return this.callGemini(prompt, retryCount + 1);
      }

      throw new Error(`API ì˜¤ë¥˜: ${responseCode}`);
    } catch (error) {
      if (retryCount < CONFIG.MAX_RETRIES - 1) {
        Utils.sleep(CONFIG.BASE_DELAY * Math.pow(2, retryCount));
        return this.callGemini(prompt, retryCount + 1);
      }
      Utils.log('API_ERROR', 'Gemini API call failed', error);
      throw error;
    }
  }
};

// ========================================
// 4. ì‹œíŠ¸ ê´€ë¦¬
// ========================================
const SheetManager = {
  getSheet(sheetName) {
    return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  },

  ensureSheetExists(sheetName, headerKey) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(sheetName);

    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
    }

    if (sheet.getLastRow() === 0) {
      this.createHeader(sheet, CONFIG.SHEET_HEADERS[headerKey]);
    }

    return sheet;
  },

  createHeader(sheet, headers) {
    sheet.appendRow(headers);
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold').setFontColor('#ffffff');
    
    const colors = {
      'ì§ì›ì •ë³´': '#4285f4',
      'íŠ¸ë Œë“œë¶„ì„': '#fbbc04',
      'ì¶”ì²œê²°ê³¼': '#34a853'
    };
    
    headerRange.setBackground(colors[sheet.getName()] || '#4285f4');
  },

  parseEmployees() {
    const sheet = this.getSheet(CONFIG.SHEETS.EMPLOYEE);
    if (!sheet) return [];

    const data = sheet.getDataRange().getValues();
    if (data.length < 2) return [];

    const headers = data[0];
    const colIndex = field => headers.indexOf(field);

    return data.slice(1)
      .filter(row => row[colIndex('ì„ íƒ')] === true)
      .filter(row => row[colIndex('ì§ì›ID')] && row[colIndex('ì´ë¦„')] && row[colIndex('ì§ë¬´')])
      .map(row => ({
        id: row[colIndex('ì§ì›ID')],
        name: row[colIndex('ì´ë¦„')],
        email: row[colIndex('ì´ë©”ì¼')],
        jobRole: row[colIndex('ì§ë¬´')],
        department: row[colIndex('ë¶€ì„œ')] || 'ë¯¸ì§€ì •',
        careerYears: row[colIndex('ê²½ë ¥(ë…„)')] || '0',
        skills: row[colIndex('ì£¼ìš” ì—­ëŸ‰')] || 'ë¯¸ì§€ì •',
        goals: row[colIndex('ëª©í‘œ ì—­ëŸ‰')] || 'ë¯¸ì§€ì •'
      }));
  },

  saveTrend(employee, trendData) {
    const sheet = this.ensureSheetExists(CONFIG.SHEETS.TREND, 'TREND');
    sheet.appendRow([
      new Date(),
      employee.id,
      employee.name,
      employee.department,
      employee.jobRole,
      trendData.keywords.join(', '),
      Utils.safeStringify(trendData.topics)
    ]);
  },

  saveResult(employee, trendData, courses, youtubeVideos) {
    const sheet = this.ensureSheetExists(CONFIG.SHEETS.RESULT, 'RESULT');
    sheet.appendRow([
      new Date(),
      employee.id,
      employee.name,
      employee.department,
      employee.jobRole,
      trendData.keywords.join(', '),
      Utils.safeStringify(trendData.topics),
      courses.map(c => `[${c.site}] ${c.title}`).join('\n'),
      courses.map(c => c.url).join('\n'),
      youtubeVideos.map(v => v.title).join('\n'),
      youtubeVideos.map(v => v.url).join('\n')
    ]);
  },

  clearResults() {
    [CONFIG.SHEETS.RESULT, CONFIG.SHEETS.TREND].forEach(sheetName => {
      const sheet = this.getSheet(sheetName);
      if (sheet) {
        sheet.clear();
        const headerKey = sheetName === CONFIG.SHEETS.RESULT ? 'RESULT' : 'TREND';
        this.createHeader(sheet, CONFIG.SHEET_HEADERS[headerKey]);
      }
    });
  }
};

// ========================================
// 5. AI ì¶”ì²œ ì—”ì§„
// ========================================
const RecommendationEngine = {
  analyzeTrend(employee) {
    const prompt = `ë‹¹ì‹ ì€ ${employee.jobRole} ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì§ë¬´ ì—­ëŸ‰ ê°•í™”ë¥¼ ìœ„í•´ ì˜¬í•´ì™€ ë‚´ë…„ì˜ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•˜ì„¸ìš”.
ì‘ë‹µ í˜•ì‹: {"keywords": ["í‚¤ì›Œë“œ5ê°œ"], "topics": ["êµ¬ì²´ì ì¸ ë¬¸ì¥ í˜•íƒœì˜ í•™ìŠµì£¼ì œ 3ê°œ"]}
í•™ìŠµ ì£¼ì œëŠ” ì‹¤ë¬´ ì ìš© ë°©ì•ˆì„ í¬í•¨í•œ ê¸´ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;

    const response = APIManager.callGemini(prompt);
    const trendData = Utils.extractJSON(response) || { keywords: [], topics: [] };
    
    SheetManager.saveTrend(employee, trendData);
    return trendData;
  },

  recommendCourses(employee, trendData) {
    const prompt = `
ë‹¹ì‹ ì€ êµìœ¡ ê²€ìƒ‰ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•™ìŠµ ì£¼ì œë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤ì œ êµìœ¡ ì‚¬ì´íŠ¸ì—ì„œ ê²€ìƒ‰ì´ ì˜ ë ë§Œí•œ í•µì‹¬ í‚¤ì›Œë“œë¡œ ìª¼ê°œê³  ì¡°í•©í•˜ì—¬ URLì„ ìƒì„±í•˜ì„¸ìš”.

**ë¶„ì„í•  í•™ìŠµ ì£¼ì œ:**
${trendData.topics.join('\n')}

**ìˆ˜í–‰ ê³¼ì œ:**
1. í•µì‹¬ ê¸°ìˆ /ê°œë…ì„ 1-3ë‹¨ì–´ë¡œ ì¶”ì¶œ (ì˜ˆ: "AIê¸°ë°˜ HR" â†’ "AI HR", "ChatGPT ì±„ìš©" â†’ "ChatGPT recruiting")
2. ìµœì†Œ 3ê°œ ì´ìƒì˜ ì„œë¡œ ë‹¤ë¥¸ êµìœ¡ í”Œë«í¼ì—ì„œ ì‹¤ì œ ê°•ì˜ ì¶”ì²œ (êµ¬ì²´ì ì¸ ê°•ì˜ ì œëª©, URL, ì´ìœ  í¬í•¨)
3. í”Œë«í¼ì€ ë§¤ìš° ë‹¤ì–‘í•˜ê²Œ ì„ íƒ

**ì¶œë ¥ í˜•ì‹ (JSON):**
{
  "courses": [
    {
      "site": "í”Œë«í¼ëª…",
      "title": "ì¶”ì²œ ê°•ì˜ ì œëª©",
      "url": "ê°•ì˜ URL",
      "reason": "ì¶”ì²œ ì´ìœ "
    }
  ]
}

í‚¤ì›Œë“œëŠ” ì •í™•íˆ ì¡°í•©í•˜ê³ , URLì€ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê°•ì˜ í˜ì´ì§€ì—¬ì•¼ í•©ë‹ˆë‹¤.`;

    const response = APIManager.callGemini(prompt);
    const result = Utils.extractJSON(response) || { courses: [] };

    if (result.courses) {
      result.courses = result.courses.map(course => {
        if (!Utils.validateUrl(course.url)) {
          const siteKey = Object.keys(CONFIG.EDUCATION_SITES)
            .find(key => CONFIG.EDUCATION_SITES[key].name.toLowerCase() === course.site.toLowerCase());
          
          course.url = siteKey ? Utils.generateSearchUrl(siteKey, course.title) : course.url;
          course.reason += ' (ê²€ìƒ‰ URLë¡œ ëŒ€ì²´ë¨)';
        }
        return course;
      });
    }

    return result.courses || [];
  },

  recommendYouTube(employee, trendData) {
    const prompt = `ì•„ë˜ ì£¼ì œì— ëŒ€í•´ YouTube ê²€ìƒ‰ URLì„ 3ê°œ ìƒì„±í•˜ì„¸ìš”. ê²€ìƒ‰ì–´ëŠ” ì •í™•í•œ í•œê¸€ë¡œ êµ¬ì„±í•˜ì„¸ìš”.

ì£¼ì œ: ${trendData.topics.join(', ')}

í˜•ì‹: {"videos": [{"title": "ê²€ìƒ‰ì–´", "url": "https://www.youtube.com/results?search_query=ì¸ì½”ë”©ëœê²€ìƒ‰ì–´", "reason": "ì´ìœ "}]}`;

    const response = APIManager.callGemini(prompt);
    return Utils.extractJSON(response)?.videos || [];
  }
};

// ========================================
// 6. ì´ë©”ì¼ ê´€ë¦¬
// ========================================
const EmailManager = {
  send(employee, trendData, courses, youtubeVideos) {
    const htmlBody = this.buildEmailBody(employee, trendData, courses, youtubeVideos);
    
    try {
      MailApp.sendEmail({
        to: employee.email,
        subject: `[êµìœ¡ì¶”ì²œ] ${employee.name}ë‹˜ì„ ìœ„í•œ ë§ì¶¤ í•™ìŠµ ê³¼ì •`,
        htmlBody: htmlBody
      });
      return true;
    } catch (e) {
      Utils.log('EMAIL_ERROR', 'Failed to send email', { employee: employee.name, error: e.message });
      return false;
    }
  },

  buildEmailBody(employee, trendData, courses, youtubeVideos) {
    return `
      <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px;">
          ğŸ“ ${employee.name}ë‹˜ì„ ìœ„í•œ ë§ì¶¤ êµìœ¡ ì¶”ì²œ
        </h1>
      
        ${this.buildTrendSection(trendData)}
        ${this.buildCoursesSection(courses)}
        ${this.buildYouTubeSection(youtubeVideos)}
        ${this.buildFooter()}
      </div>
    `;
  },

  buildTrendSection(trendData) {
    return `
      <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h2 style="color: #16a085; margin-top: 0;">ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„ ê²°ê³¼</h2>
        <p><strong>í•µì‹¬ í‚¤ì›Œë“œ:</strong> ${trendData.keywords.join(', ')}</p>
        <p><strong>ì¶”ì²œ í•™ìŠµ ì£¼ì œ:</strong></p>
        <ul>
          ${trendData.topics.map(topic => `<li>${Utils.escapeHtml(topic)}</li>`).join('')}
        </ul>
      </div>
    `;
  },

  buildCoursesSection(courses) {
    const coursesHtml = courses.map(course => `
      <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 5px solid #3498db;">
        <h3 style="color: #2c3e50; margin: 0 0 10px 0;">${Utils.escapeHtml(course.title)}</h3>
        <p style="margin: 5px 0; color: #7f8c8d;"><strong>í”Œë«í¼:</strong> ${Utils.escapeHtml(course.site)}</p>
        <p style="margin: 5px 0; color: #34495e;">${Utils.escapeHtml(course.reason)}</p>
        <p style="margin: 10px 0 0 0;">
          <a href="${course.url}" style="display: inline-block; padding: 10px 20px; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
            ğŸ” [${Utils.escapeHtml(course.site)}]ì—ì„œ ê°•ì¢Œ í™•ì¸í•˜ê¸°
          </a>
        </p>
      </div>
    `).join('');

    return `
      <h2 style="color: #16a085; margin-top: 30px;">ğŸ’¡ ì¶”ì²œ êµìœ¡ ê³¼ì •</h2>
      ${coursesHtml || '<p>ì¶”ì²œ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
    `;
  },

  buildYouTubeSection(youtubeVideos) {
    const youtubeHtml = youtubeVideos.map(video => `
      <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px;">
        <h4 style="color: #856404; margin: 0 0 8px 0;">YouTube ê²€ìƒ‰: ${Utils.escapeHtml(video.title)}</h4>
        <p style="margin: 10px 0 0 0;">
          <a href="${video.url}" style="display: inline-block; padding: 10px 20px; background: #ff0000; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
            â–¶ï¸ YouTube ê²€ìƒ‰ê²°ê³¼ ë³´ê¸°
          </a>
        </p>
      </div>
    `).join('');

    return `
      <h2 style="color: #d68910; margin-top: 30px;">ğŸ¬ ì¶”ì²œ YouTube ì˜ìƒ</h2>
      ${youtubeHtml || '<p>ì¶”ì²œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
    `;
  },

  buildFooter() {
    return `
      <div style="margin-top: 40px; padding: 15px; background: #ecf0f1; border-radius: 8px; text-align: center;">
        <p style="color: #7f8c8d; margin: 0;">
          ë³¸ ì¶”ì²œì€ Gemini AIê°€ ${new Date().toLocaleDateString('ko-KR')} ê¸°ì¤€ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
        </p>
        <p style="color: #95a5a6; margin: 5px 0 0 0; font-size: 12px;">
          â€» AIê°€ ì§ì ‘ ì„ ì •í•œ ì‹¤ì œ ê³¼ì •/ì˜ìƒ í˜ì´ì§€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        </p>
      </div>
    `;
  }
};

// ========================================
// 7. ë©”ì¸ ì²˜ë¦¬ í•¨ìˆ˜
// ========================================
function processSelectedEmployees() {
  const ui = SpreadsheetApp.getUi();

  Utils.showProgress('ğŸ“‹ ì§ì› ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘...', 2);
  const employees = SheetManager.parseEmployees();

  if (employees.length === 0) {
    return ui.alert('âŒ ì²˜ë¦¬ ê°€ëŠ¥í•œ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
  }

  if (employees.length > CONFIG.BATCH_SIZE) {
    const response = ui.alert(
      'âš ï¸ ëŒ€ëŸ‰ ì²˜ë¦¬ ê²½ê³ ',
      `${employees.length}ëª… ì²˜ë¦¬ ì˜ˆì •ì…ë‹ˆë‹¤. 3ëª…ì”© ê¶Œì¥ë©ë‹ˆë‹¤.`,
      ui.ButtonSet.YES_NO
    );
    if (response !== ui.Button.YES) return;
  }

  const results = { success: 0, fail: 0, failed: [] };

  employees.forEach((emp, i) => {
    try {
      Utils.showProgress(`ğŸ” [${i + 1}/${employees.length}] ${emp.name}ë‹˜ íŠ¸ë Œë“œ ë¶„ì„ ì¤‘...`, 3);
      const trend = RecommendationEngine.analyzeTrend(emp);

      Utils.showProgress(`ğŸ“š [${i + 1}/${employees.length}] ${emp.name}ë‹˜ êµìœ¡ ê³¼ì • ì¶”ì²œ ì¤‘...`, 3);
      const courses = RecommendationEngine.recommendCourses(emp, trend);

      Utils.showProgress(`ğŸ¬ [${i + 1}/${employees.length}] ${emp.name}ë‹˜ YouTube ì˜ìƒ ì¶”ì²œ ì¤‘...`, 3);
      const youtube = RecommendationEngine.recommendYouTube(emp, trend);

      Utils.showProgress(`ğŸ“§ [${i + 1}/${employees.length}] ${emp.name}ë‹˜ê»˜ ì´ë©”ì¼ ë°œì†¡ ì¤‘...`, 3);
      
      if (EmailManager.send(emp, trend, courses, youtube)) {
        SheetManager.saveResult(emp, trend, courses, youtube);
        results.success++;
        Utils.showProgress(`âœ… [${i + 1}/${employees.length}] ${emp.name}ë‹˜ ì²˜ë¦¬ ì™„ë£Œ!`, 2);
      } else {
        results.failed.push(emp.name);
        results.fail++;
      }

      if (i < employees.length - 1) {
        Utils.sleep(CONFIG.PROCESS_DELAY);
      }
    } catch (e) {
      Utils.log('PROCESS_ERROR', `Failed to process employee: ${emp.name}`, e);
      results.failed.push(emp.name);
      results.fail++;
    }
  });

  Utils.showProgress(`ğŸ‰ ì²˜ë¦¬ ì™„ë£Œ! ì„±ê³µ: ${results.success}ëª…, ì‹¤íŒ¨: ${results.fail}ëª…`, 5);
  ui.alert(`ì²˜ë¦¬ ì™„ë£Œ\n\nì„±ê³µ: ${results.success}ëª…\nì‹¤íŒ¨: ${results.fail}ëª…`);
}

// ========================================
// 8. ì´ˆê¸°í™” ë° ì„¤ì •
// ========================================
function initializeSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // ì§ì›ì •ë³´ ì‹œíŠ¸
  if (!ss.getSheetByName(CONFIG.SHEETS.EMPLOYEE)) {
    const sheet = ss.insertSheet(CONFIG.SHEETS.EMPLOYEE);
    SheetManager.createHeader(sheet, CONFIG.SHEET_HEADERS.EMPLOYEE);
    sheet.getRange('A2:A100').insertCheckboxes();
    sheet.getRange('K2:K100').setValue('í™œì„±');
    
    const columnWidths = [50, 80, 100, 200, 120, 100, 80, 120, 120, 80, 80];
    columnWidths.forEach((width, i) => sheet.setColumnWidth(i + 1, width));
  }

  // íŠ¸ë Œë“œë¶„ì„ ì‹œíŠ¸
  SheetManager.ensureSheetExists(CONFIG.SHEETS.TREND, 'TREND');

  // ì¶”ì²œê²°ê³¼ ì‹œíŠ¸
  SheetManager.ensureSheetExists(CONFIG.SHEETS.RESULT, 'RESULT');
}

// ========================================
// 9. ë©”ë‰´ ë° UI
// ========================================
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ğŸ“ êµìœ¡ ì¶”ì²œ')
    .addItem('âš™ï¸ ì´ˆê¸° ì„¤ì •', 'showInitialSetup')
    .addSeparator()
    .addItem('ğŸ‘¥ ì„ íƒí•œ ì§ì› ì¶”ì²œ', 'processSelectedEmployees')
    .addSeparator()
    .addSubMenu(
      SpreadsheetApp.getUi().createMenu('ğŸ”§ ê³ ê¸‰ ì„¤ì •')
        .addItem('ğŸ”‘ API í‚¤ ì¬ì„¤ì •', 'resetApiKey')
        .addItem('ğŸ“Š ìºì‹œ ì´ˆê¸°í™”', 'clearCache')
        .addItem('ğŸ—‘ï¸ ê²°ê³¼ ë°ì´í„° ì‚­ì œ', 'clearResults')
    )
    .addSeparator()
    .addItem('â“ ë„ì›€ë§', 'showHelp')
    .addToUi();
}

function showInitialSetup() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'âš™ï¸ Gemini API ì„¤ì •',
    'Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return ui.alert('âŒ ì„¤ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }

  const apiKey = response.getResponseText().trim();
  if (!apiKey) {
    return ui.alert('âŒ API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  PROPS.setProperty('GEMINI_API_KEY', apiKey);
  PROPS.setProperty('SPREADSHEET_ID', SpreadsheetApp.getActiveSpreadsheet().getId());
  
  initializeSheets();
  
  Utils.showProgress('âœ… ì´ˆê¸° ì„¤ì • ì™„ë£Œ!', 3);
  ui.alert('âœ… ì„¤ì • ì™„ë£Œ!\n\nì§ì› ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•œ í›„\n"ì„ íƒí•œ ì§ì› ì¶”ì²œ" ë©”ë‰´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
}

function resetApiKey() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'ğŸ”‘ API í‚¤ ì¬ì„¤ì •',
    'ìƒˆë¡œìš´ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) return;

  const newApiKey = response.getResponseText().trim();
  if (!newApiKey) {
    return ui.alert('âŒ API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  PROPS.setProperty('GEMINI_API_KEY', newApiKey);
  CACHE.removeAll(['trend_']);
  ui.alert('âœ… API í‚¤ê°€ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function clearCache() {
  CACHE.removeAll(['trend_']);
  SpreadsheetApp.getUi().alert('âœ… ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function clearResults() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'ğŸ—‘ï¸ ê²°ê³¼ ë°ì´í„° ì‚­ì œ',
    'ì¶”ì²œê²°ê³¼ì™€ íŠ¸ë Œë“œë¶„ì„ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  SheetManager.clearResults();
  ui.alert('âœ… ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function showHelp() {
  const helpText = `
ğŸ“š Gemini AI êµìœ¡ ì¶”ì²œ ì‹œìŠ¤í…œ v4.5

ã€ì´ˆê¸° ì„¤ì •ã€‘
1. ë©”ë‰´ì—ì„œ "ì´ˆê¸° ì„¤ì •" í´ë¦­
2. Gemini API í‚¤ ì…ë ¥
3. ìë™ìœ¼ë¡œ í•„ìš”í•œ ì‹œíŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤

ã€ì‚¬ìš© ë°©ë²•ã€‘
1. ì§ì›ì •ë³´ ì‹œíŠ¸ì— ë°ì´í„° ì…ë ¥
2. Aì—´ ì²´í¬ë°•ìŠ¤ë¡œ ì§ì› ì„ íƒ
3. "ì„ íƒí•œ ì§ì› ì¶”ì²œ" ë©”ë‰´ ì‹¤í–‰

ã€ë¬¸ì˜ã€‘
ë¬¸ì œ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
  `;

  SpreadsheetApp.getUi().alert('â“ ë„ì›€ë§', helpText, SpreadsheetApp.getUi().ButtonSet.OK);
}
