/**
 * ========================================
 * Gemini AI ê¸°ë°˜ êµìœ¡ ì¶”ì²œ ì‹œìŠ¤í…œ v4.1
 * ========================================
 * * ì£¼ìš” ìˆ˜ì • ì‚¬í•­:
 * 1. ì¶”ì²œ ì£¼ì œ ë¬¸ì¥ì„ ê²€ìƒ‰ìš© í•µì‹¬ í‚¤ì›Œë“œë¡œ ë¶„í•´ ë° ì¡°í•© ë¡œì§ ì¶”ê°€
 * 2. ì´ë©”ì¼ ë²„íŠ¼ ë‚´ í”Œë«í¼ëª… ë™ì  í‘œì‹œ (ex: [Udemyì—ì„œ ê°•ì¢Œ ê²€ìƒ‰í•˜ê¸°])
 * 3. ìµœì†Œ 3ê°œ ì´ìƒì˜ ë‹¤ì–‘í•œ í”Œë«í¼ URL ìƒì„± ë³´ì¥
 * 4. íŠ¸ë Œë“œ ë¶„ì„ ì‹œíŠ¸ ê¸°ë¡ ëˆ„ë½ ìˆ˜ì • (analyzeTrendì—ì„œ saveTrend í˜¸ì¶œ ì¶”ê°€)
 * 5. CONFIG ëª¨ë“ˆ ìˆ˜ì • (ì œê³µëœ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
 * 6. ë©”ì¼ ì œëª© ìˆ˜ì •: êµìœ¡ê°€ì´ë“œ â†’ êµìœ¡ì¶”ì²œ
 * 7. ë©”ì¼ ë‚´ìš© í˜•ì‹ ì—…ë°ì´íŠ¸ (ì œê³µëœ htmlBody ë°˜ì˜)
 * 8. í”Œë«í¼ ë¦¬ìŠ¤íŠ¸ í™•ëŒ€: êµ­ë‚´ êµìœ¡ í”Œë«í¼/ê¸°ê´€ ë‹¤ì–‘í™” (K-MOOC, ì—˜ë¦¬ìŠ¤ ë“± ì¶”ê°€)
 * 9. ê²€ìƒ‰ í‚¤ì›Œë“œ ì •í™•ë„ ê°•í™”: í”„ë¡¬í”„íŠ¸ì— ë” ë§ì€ ì˜ˆì‹œ ë° ì§€ì¹¨ ì¶”ê°€
 * 10. ë©”ë‰´ ë° ì´ˆê¸° ì„¤ì • ëª¨ë“ˆ ì¶”ê°€ (onOpen, showInitialSetup, resetApiKey ë“±)
 */
// ========================================
// 1. ì„¤ì • ë° ìƒìˆ˜
// ========================================
const CONFIG = {
  GEMINI_API_KEY: PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY'),
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemma-3-12b-it:generateContent',
  MAX_RETRIES: 5,
  BASE_DELAY: 1000,
  CACHE_HOURS: 6,
  BATCH_SIZE: 3,
  PROCESS_DELAY: 5000,
  SHEETS: {
    EMPLOYEE: 'ì§ì›ì •ë³´',
    TREND: 'íŠ¸ë Œë“œë¶„ì„',
    RESULT: 'ì¶”ì²œê²°ê³¼'
  }
};
const PROPS = PropertiesService.getScriptProperties();
const CACHE = CacheService.getScriptCache();
// ========================================
// 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ========================================
const Utils = {
  log(category, message, data = null) {
    const timestamp = new Date().toISOString();
    let logMessage = `[${timestamp}] [${category}] ${message}`;
    if (data) {
      try { logMessage += '\n' + JSON.stringify(data, null, 2); } catch (e) { logMessage += '\n' + String(data); }
    }
    console.log(logMessage);
  },
  sleep(ms) { Utilities.sleep(ms); },
  isValidUrl(url) {
    if (!url || typeof url !== 'string') return false;
    return /^https?:\/\/.+/i.test(url);
  },
  escapeHtml(text) {
    if (!text) return '';
    return text.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  },
  extractJSON(text) {
    if (!text) return null;
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) { try { return JSON.parse(jsonMatch[0]); } catch (e) { return null; } }
    return null;
  }
};
// ========================================
// 3. Gemini API í˜¸ì¶œ
// ========================================
function callGeminiAPI(prompt, retryCount = 0) {
  try {
    const response = UrlFetchApp.fetch(`${CONFIG.GEMINI_API_URL}?key=${CONFIG.GEMINI_API_KEY}`, {
      method: 'post',
      contentType: 'application/json',
      muteHttpExceptions: true,
      payload: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
      })
    });
    const responseCode = response.getResponseCode();
    if (responseCode === 200) return JSON.parse(response.getContentText())?.candidates?.[0]?.content?.parts?.[0]?.text;
    if ((responseCode === 429 || responseCode === 503) && retryCount < CONFIG.MAX_RETRIES - 1) {
      Utils.sleep(CONFIG.BASE_DELAY * Math.pow(2, retryCount));
      return callGeminiAPI(prompt, retryCount + 1);
    }
    throw new Error(`API ì˜¤ë¥˜: ${responseCode}`);
  } catch (error) {
    if (retryCount < CONFIG.MAX_RETRIES - 1) {
      Utils.sleep(CONFIG.BASE_DELAY * Math.pow(2, retryCount));
      return callGeminiAPI(prompt, retryCount + 1);
    }
    throw error;
  }
}
// ========================================
// 4. ì§ì› ë°ì´í„° íŒŒì‹±
// ========================================
function parseEmployees() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEETS.EMPLOYEE);
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return [];
  const headers = data[0];
  const col = {
    selected: headers.indexOf('ì„ íƒ'), id: headers.indexOf('ì§ì›ID'), name: headers.indexOf('ì´ë¦„'),
    email: headers.indexOf('ì´ë©”ì¼'), jobRole: headers.indexOf('ì§ë¬´'), department: headers.indexOf('ë¶€ì„œ'),
    careerYears: headers.indexOf('ê²½ë ¥(ë…„)'), skills: headers.indexOf('ì£¼ìš” ì—­ëŸ‰'), goals: headers.indexOf('ëª©í‘œ ì—­ëŸ‰')
  };
  const employees = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][col.selected] === true) {
      employees.push({
        id: data[i][col.id], name: data[i][col.name], email: data[i][col.email],
        jobRole: data[i][col.jobRole], department: data[i][col.department],
        careerYears: data[i][col.careerYears], skills: data[i][col.skills], goals: data[i][col.goals]
      });
    }
  }
  return employees;
}
// ========================================
// 5. íŠ¸ë Œë“œ ë¶„ì„ ì‹œíŠ¸ í—¤ë” ë³´ì¥
// ========================================
function ensureTrendSheetHeader() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(CONFIG.SHEETS.TREND);
 
  if (!sheet) {
    sheet = ss.insertSheet(CONFIG.SHEETS.TREND);
  }
 
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      'ë¶„ì„ì¼ì‹œ',
      'ì§ì›ID',
      'ì´ë¦„',
      'ë¶€ì„œ',
      'ì§ë¬´',
      'í•µì‹¬ í‚¤ì›Œë“œ',
      'ì¶”ì²œ í•™ìŠµ ì£¼ì œ'
    ]);
    sheet.getRange('A1:G1').setFontWeight('bold').setBackground('#fbbc04').setFontColor('#ffffff');
    Utils.log('TREND_SHEET', 'âœ… íŠ¸ë Œë“œë¶„ì„ ì‹œíŠ¸ í—¤ë” ìƒì„± ì™„ë£Œ');
  }
}
// ========================================
// 6. íŠ¸ë Œë“œ ë¶„ì„
// ========================================
function analyzeTrend(employee) {
  const prompt = `ë‹¹ì‹ ì€ ${employee.jobRole} ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì§ë¬´ ì—­ëŸ‰ ê°•í™”ë¥¼ ìœ„í•´ 2025ë…„ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•˜ì„¸ìš”.
  ì‘ë‹µ í˜•ì‹: {"keywords": ["í‚¤ì›Œë“œ5ê°œ"], "topics": ["êµ¬ì²´ì ì¸ ë¬¸ì¥ í˜•íƒœì˜ í•™ìŠµì£¼ì œ 3ê°œ"]}
  í•™ìŠµ ì£¼ì œëŠ” ì‹¤ë¬´ ì ìš© ì ìš© ë°©ì•ˆì„ í¬í•¨í•œ ê¸´ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;
  const res = callGeminiAPI(prompt);
  const trendData = Utils.extractJSON(res) || { keywords: [], topics: [] };
  saveTrend(employee, trendData);  // ì‹œíŠ¸ ê¸°ë¡ ëˆ„ë½ ìˆ˜ì •: ë¶„ì„ í›„ ì¦‰ì‹œ ì €ì¥
  return trendData;
}
// ========================================
// 7. ê³¼ì • ì¶”ì²œ ëª¨ë“ˆ (í‚¤ì›Œë“œ íŒŒì‹± ë° ì¡°í•© ë¡œì§ ê°•í™”)
// ========================================
function recommendCourses(employee, trendData) {
  Utils.log('COURSE_RECOMMEND', `=== í‚¤ì›Œë“œ ì¡°í•© ë° í”Œë«í¼ ê²€ìƒ‰ ì‹œì‘: ${employee.name} ===`);
 
  const prompt = `
ë‹¹ì‹ ì€ êµìœ¡ ê²€ìƒ‰ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸´ 'ì¶”ì²œ í•™ìŠµ ì£¼ì œ' ë¬¸ì¥ì„ ë¶„ì„í•˜ì—¬ ì‹¤ì œ êµìœ¡ ì‚¬ì´íŠ¸ì—ì„œ ê²€ìƒ‰ì´ ì˜ ë ë§Œí•œ 'í•µì‹¬ ë‹¨ì–´'ë¡œ ìª¼ê°œê³  ì¡°í•©í•˜ì—¬ ê²€ìƒ‰ URLì„ ìƒì„±í•˜ì„¸ìš”.
**ë¶„ì„í•  í•™ìŠµ ì£¼ì œ ë¬¸ì¥:**
${trendData.topics.join('\n')}
**ìˆ˜í–‰ ê³¼ì œ:**
1. ìœ„ ë¬¸ì¥ì—ì„œ í•µì‹¬ ê¸°ìˆ /ê°œë…ì„ ì¶”ì¶œí•˜ì„¸ìš” (ì˜ˆ: "AIê¸°ë°˜ HR" â†’ "AI HR", "ChatGPT ì±„ìš©" â†’ "ChatGPT recruiting", "ë°ì´í„° í¸í–¥ì„±" â†’ "data bias"). ë¶€ì •í™•í•˜ê±°ë‚˜ ë„ˆë¬´ ê¸´ í‚¤ì›Œë“œëŠ” í”¼í•˜ì„¸ìš”. ê° í‚¤ì›Œë“œëŠ” 1-3ë‹¨ì–´ë¡œ ê°„ê²°í•˜ê²Œ.
2. ì¶”ì¶œëœ í‚¤ì›Œë“œë¥¼ í™œìš©í•˜ì—¬ **ìµœì†Œ 3ê°œ ì´ìƒì˜ ì„œë¡œ ë‹¤ë¥¸ êµìœ¡ í”Œë«í¼**ì˜ ê²€ìƒ‰ ê²°ê³¼ URLì„ ìƒì„±í•˜ì„¸ìš”. í”Œë«í¼ ê°„ ì¤‘ë³µ í‚¤ì›Œë“œ í”¼í•˜ê³ , ì •í™•í•œ ê²€ìƒ‰ì–´ ì¡°í•© ì‚¬ìš©.
3. í”Œë«í¼ ë¦¬ìŠ¤íŠ¸ (ë‹¤ì–‘í•˜ê²Œ ì„ íƒ): ì¸í”„ëŸ°, Udemy, íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤, Coursera, í´ë˜ìŠ¤101, K-MOOC, ì—˜ë¦¬ìŠ¤, í”„ë¡œê·¸ë˜ë¨¸ìŠ¤, êµ¬ë¦„, SBAì•„ì¹´ë°ë¯¸, í¬ëª½í´ë˜ìŠ¤, LinkedIn Learning, edX.
**ê²€ìƒ‰ URL í˜•ì‹ ê°€ì´ë“œ (ì •í™•íˆ ì¤€ìˆ˜):**
- ì¸í”„ëŸ°: https://www.inflearn.com/courses?s=[í‚¤ì›Œë“œ]
- Udemy: https://www.udemy.com/courses/search/?q=[í‚¤ì›Œë“œ]
- íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤: https://fastcampus.co.kr/search?keyword=[í‚¤ì›Œë“œ]
- Coursera: https://www.coursera.org/search?query=[í‚¤ì›Œë“œ]
- í´ë˜ìŠ¤101: https://class101.net/search?query=[í‚¤ì›Œë“œ]
- K-MOOC: http://www.kmooc.kr/courses?search_query=[í‚¤ì›Œë“œ]
- ì—˜ë¦¬ìŠ¤: https://elice.io/explore?query=[í‚¤ì›Œë“œ]
- í”„ë¡œê·¸ë˜ë¨¸ìŠ¤: https://school.programmers.co.kr/learn/courses?query=[í‚¤ì›Œë“œ]
- êµ¬ë¦„: https://edu.goorm.io/search?keyword=[í‚¤ì›Œë“œ]
- SBAì•„ì¹´ë°ë¯¸: https://www.sbacademy.co.kr/search?keyword=[í‚¤ì›Œë“œ]
- í¬ëª½í´ë˜ìŠ¤: https://kmong.com/class/search?keyword=[í‚¤ì›Œë“œ]
- LinkedIn Learning: https://www.linkedin.com/learning/search?keywords=[í‚¤ì›Œë“œ]
- edX: https://www.edx.org/search?q=[í‚¤ì›Œë“œ]
**ì¶œë ¥ í˜•ì‹ (JSON):**
{
  "courses": [
    {
      "site": "í”Œë«í¼ëª…",
      "keyword": "ê²€ìƒ‰ì— ì‚¬ìš©í•œ í•µì‹¬ ì¡°í•© ë‹¨ì–´",
      "url": "ê²€ìƒ‰ ê²°ê³¼ URL",
      "reason": "ì´ í‚¤ì›Œë“œ ì¡°í•©ìœ¼ë¡œ ì¶”ì²œí•˜ëŠ” ì´ìœ "
    }
  ]
}
ë°˜ë“œì‹œ 3ê°œ ì´ìƒì˜ ê°ê¸° ë‹¤ë¥¸ í”Œë«í¼ì„ ì‚¬ìš©í•˜ì—¬ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”. í‚¤ì›Œë“œëŠ” ë¶€ì •í™•í•˜ì§€ ì•Šê²Œ ì •í™•íˆ ì¡°í•©í•˜ì„¸ìš”.`;
  const response = callGeminiAPI(prompt);
  const result = Utils.extractJSON(response);
  return result || { courses: [] };
}

// ========================================
// 8. YouTube ì¶”ì²œ
// ========================================
function recommendYouTube(employee, trendData) {
  const prompt = `ì•„ë˜ ì£¼ì œì— ëŒ€í•´ YouTube ê²€ìƒ‰ ê²°ê³¼ URLì„ 3ê°œ ìƒì„±í•˜ì„¸ìš”.
  ì£¼ì œ: ${trendData.topics.join(', ')}
  í˜•ì‹: {"videos": [{"title": "ê²€ìƒ‰ì–´", "url": "https://www.youtube.com/results?search_query=í‚¤ì›Œë“œ", "reason": "ì´ìœ "}]}`;
  const res = callGeminiAPI(prompt);
  return Utils.extractJSON(res)?.videos || [];
}
// ========================================
// 9. íŠ¸ë Œë“œ ë¶„ì„ ì €ì¥
// ========================================
function saveTrend(employee, trendData) {
  ensureTrendSheetHeader();  // í—¤ë” ë³´ì¥
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEETS.TREND);
  const timestamp = new Date();
  
  sheet.appendRow([
    timestamp,
    employee.id || '',
    employee.name || '',
    employee.department || '',
    employee.jobRole || '',
    trendData.keywords.join(', '),
    trendData.topics.join('\n')
  ]);
  
  Utils.log('TREND_SAVE', `âœ… ì €ì¥ ì™„ë£Œ: ${employee.name}`);
}
// ========================================
// 10. ì´ë©”ì¼ ë°œì†¡ (ì œëª© ë° ë‚´ìš© í˜•ì‹ ìˆ˜ì •)
// ========================================
function sendEmail(employee, trendData, courses, youtubeVideos) {
  const coursesHtml = courses.map((course) => `
    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 5px solid #3498db;">
      <h3 style="color: #2c3e50; margin: 0 0 10px 0;">ê²€ìƒ‰ì–´: ${Utils.escapeHtml(course.keyword)}</h3>
      <p style="margin: 5px 0; color: #34495e;">${Utils.escapeHtml(course.reason)}</p>
      <p style="margin: 10px 0 0 0;">
        <a href="${course.url}" style="display: inline-block; padding: 10px 20px; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
          ğŸ” [${Utils.escapeHtml(course.site)}]ì—ì„œ ê°•ì¢Œ ê²€ìƒ‰í•˜ê¸°
        </a>
      </p>
    </div>
  `).join('');
  const youtubeHtml = youtubeVideos.map((video) => `
    <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px;">
      <h4 style="color: #856404; margin: 0 0 8px 0;">YouTube ê²€ìƒ‰: ${Utils.escapeHtml(video.title)}</h4>
      <p style="margin: 10px 0 0 0;">
        <a href="${video.url}" style="display: inline-block; padding: 10px 20px; background: #ff0000; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
          â–¶ï¸ YouTube ê²€ìƒ‰ê²°ê³¼ ë³´ê¸°
        </a>
      </p>
    </div>
  `).join('');
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
      <h1 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px;">
        ğŸ“ ${employee.name}ë‹˜ì„ ìœ„í•œ ë§ì¶¤ êµìœ¡ ì¶”ì²œ
      </h1>
    
      <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h2 style="color: #16a085; margin-top: 0;">ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„ ê²°ê³¼</h2>
        <p><strong>í•µì‹¬ í‚¤ì›Œë“œ:</strong> ${trendData.keywords.join(', ')}</p>
        <p><strong>ì¶”ì²œ í•™ìŠµ ì£¼ì œ:</strong></p>
        <ul>
          ${trendData.topics.map(topic => `<li>${Utils.escapeHtml(topic)}</li>`).join('')}
        </ul>
      </div>
     
      <h2 style="color: #16a085; margin-top: 30px;">ğŸ’¡ ì¶”ì²œ êµìœ¡ ê³¼ì •</h2>
      ${coursesHtml || '<p>ì¶”ì²œ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
     
      <h2 style="color: #d68910; margin-top: 30px;">ğŸ¬ ì¶”ì²œ YouTube ì˜ìƒ</h2>
      ${youtubeHtml || '<p>ì¶”ì²œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
     
      <div style="margin-top: 40px; padding: 15px; background: #ecf0f1; border-radius: 8px; text-align: center;">
        <p style="color: #7f8c8d; margin: 0;">
          ë³¸ ì¶”ì²œì€ Gemini AIê°€ ${new Date().toLocaleDateString('ko-KR')} ê¸°ì¤€ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
        </p>
        <p style="color: #95a5a6; margin: 5px 0 0 0; font-size: 12px;">
          â€» AIê°€ ì§ì ‘ ì„ ì •í•œ ì‹¤ì œ ê³¼ì •/ì˜ìƒ í˜ì´ì§€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  `;
  try {
    MailApp.sendEmail({ to: employee.email, subject: `[êµìœ¡ì¶”ì²œ] ${employee.name}ë‹˜ì„ ìœ„í•œ ë§ì¶¤ í•™ìŠµ ê³¼ì •`, htmlBody: htmlBody });
    return true;
  } catch (e) { return false; }
}
// ========================================
// 11. ê²°ê³¼ ì €ì¥
// ========================================
function saveResult(employee, trendData, courses, youtubeVideos) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEETS.RESULT);
  if (!sheet) return;
 
  // [object Object] ë°©ì§€ë¥¼ ìœ„í•œ ë¬¸ìì—´ ì²˜ë¦¬ ê°•í™”
  const topicsStr = Array.isArray(trendData.topics)
    ? trendData.topics.map(t => typeof t === 'object' ? JSON.stringify(t) : t).join('\n')
    : String(trendData.topics);
   
  const courseKeywords = courses.map(c => `[${c.site}] ${c.keyword}`).join('\n');
  const courseUrls = courses.map(c => c.url).join('\n');
  sheet.appendRow([
    new Date(), employee.id, employee.name, employee.department, employee.jobRole,
    trendData.keywords.join(', '),
    topicsStr,
    courseKeywords,
    courseUrls,
    youtubeVideos.map(v => v.title).join('\n'),
    youtubeVideos.map(v => v.url).join('\n')
  ]);
}
// ========================================
// 12. ë©”ì¸ ì²˜ë¦¬ í•¨ìˆ˜
// ========================================
function processSelectedEmployees() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(CONFIG.SHEETS.EMPLOYEE);
  const ui = SpreadsheetApp.getUi();

  if (!sheet) {
    return ui.alert('âŒ ì§ì›ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  const data = sheet.getDataRange().getValues();
  const employees = [];
  const invalidRows = [];

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] !== true) continue;

    const hasId = String(data[i][1]).trim() !== '';
    const hasName = String(data[i][2]).trim() !== '';
    const hasJob = String(data[i][4]).trim() !== '';

    if (!hasId || !hasName || !hasJob) {
      invalidRows.push(i + 1);
      continue;
    }

    employees.push({
      row: i + 1,
      id: data[i][1],
      name: data[i][2],
      email: data[i][3],
      jobRole: data[i][4],
      department: data[i][5] || 'ë¯¸ì§€ì •',
      careerYears: data[i][6] || '0',
      skills: data[i][7] || 'ë¯¸ì§€ì •',
      goals: data[i][8] || 'ë¯¸ì§€ì •'
    });
  }

  if (employees.length === 0) {
    return ui.alert('âŒ ì²˜ë¦¬ ê°€ëŠ¥í•œ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
  }

  if (employees.length > CONFIG.BATCH_SIZE) {
    if (ui.alert('âš ï¸ ëŒ€ëŸ‰ ì²˜ë¦¬ ê²½ê³ ', `${employees.length}ëª… ì²˜ë¦¬. 3ëª…ì”© ê¶Œì¥`, ui.ButtonSet.YES_NO) !== ui.Button.YES) {
      return;
    }
  }

  let success = 0, fail = 0;
  const failed = [];

  employees.forEach((emp, i) => {
    try {
      const trend = analyzeTrend(emp);
      const { courses } = recommendCourses(emp, trend);
      const youtube = recommendYouTube(emp, trend);
      if (sendEmail(emp, trend, courses, youtube)) {
        saveResult(emp, trend, courses, youtube);
        success++;
      } else {
        failed.push(emp.name);
        fail++;
      }
      if (i < employees.length - 1) Utils.sleep(CONFIG.PROCESS_DELAY);
    } catch (e) {
      failed.push(emp.name);
      fail++;
    }
  });

  ui.alert(`ì²˜ë¦¬ ì™„ë£Œ: ì„±ê³µ ${success}ëª…, ì‹¤íŒ¨ ${fail}ëª…`);
}
// ========================================
// 13. ë©”ë‰´ ë° ì´ˆê¸° ì„¤ì • ëª¨ë“ˆ
// ========================================
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ğŸ“ êµìœ¡ ì¶”ì²œ')
    .addItem('âš™ï¸ ì´ˆê¸° ì„¤ì •', 'showInitialSetup')
    .addSeparator()
    .addItem('ğŸ‘¥ ì„ íƒí•œ ì§ì› ì¶”ì²œ', 'processSelectedEmployees')
    .addSeparator()
    .addSubMenu(SpreadsheetApp.getUi().createMenu('ğŸ”§ ê³ ê¸‰ ì„¤ì •')
      .addItem('ğŸ”‘ API í‚¤ ì¬ì„¤ì •', 'resetApiKey')
      .addItem('ğŸ“Š ìºì‹œ ì´ˆê¸°í™”', 'clearCache')
      .addItem('ğŸ—‘ï¸ ê²°ê³¼ ë°ì´í„° ì‚­ì œ', 'clearResults'))
    .addSeparator()
    .addItem('â“ ë„ì›€ë§', 'showHelp')
    .addToUi();
}
function showInitialSetup() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'âš™ï¸ Gemini API ì„¤ì •',
    'Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() !== ui.Button.OK) {
    return ui.alert('âŒ ì„¤ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
  const apiKey = response.getResponseText().trim();
  if (!apiKey) {
    return ui.alert('âŒ API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }
  PROPS.setProperty('GEMINI_API_KEY', apiKey);
  PROPS.setProperty('SPREADSHEET_ID', SpreadsheetApp.getActiveSpreadsheet().getId());
  initializeSheets();
  SpreadsheetApp.getActiveSpreadsheet().toast('âœ… ì´ˆê¸° ì„¤ì • ì™„ë£Œ!', 'ì™„ë£Œ', 3);
  ui.alert('âœ… ì„¤ì • ì™„ë£Œ!\n\nì§ì› ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•œ í›„\n"ì„ íƒí•œ ì§ì› ì¶”ì²œ" ë©”ë‰´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
}
function resetApiKey() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'ğŸ”‘ API í‚¤ ì¬ì„¤ì •',
    'ìƒˆë¡œìš´ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”:',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() !== ui.Button.OK) return;
  const newApiKey = response.getResponseText().trim();
  if (!newApiKey) return ui.alert('âŒ API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  PROPS.setProperty('GEMINI_API_KEY', newApiKey);
  CACHE.removeAll(['trend_']);
  ui.alert('âœ… API í‚¤ê°€ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
// ========================================
// 8. ì‹œíŠ¸ ì´ˆê¸°í™” (v3.8ì—ì„œ í†µí•©)
// ========================================
function initializeSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  createSheetIfNotExists(ss, 'ì§ì›ì •ë³´', () => {
    const sheet = ss.getSheetByName('ì§ì›ì •ë³´');
    sheet.getRange('A1:L1').setValues([[
      'ì„ íƒ', 'ì§ì›ID', 'ì´ë¦„', 'ì´ë©”ì¼', 'ì§ë¬´', 'ë¶€ì„œ', 'ê²½ë ¥(ë…„)',
      'í˜„ì¬ ì—­ëŸ‰', 'ëª©í‘œ ì—­ëŸ‰', 'ì˜ˆì‚°(ë§Œì›)', 'ì„ í˜¸ ë°©ì‹', 'ìƒíƒœ'
    ]]).setFontWeight('bold').setBackground('#4285f4').setFontColor('#ffffff');
    const columnWidths = [50, 80, 100, 200, 120, 100, 80, 120, 120, 80, 150, 80];
    columnWidths.forEach((width, i) => sheet.setColumnWidth(i + 1, width));
    sheet.getRange('A2:A100').insertCheckboxes();
    sheet.getRange('L2:L100').setValue('í™œì„±');
  });

  createSheetIfNotExists(ss, 'ì¶”ì²œê²°ê³¼', () => {
    const sheet = ss.getSheetByName('ì¶”ì²œê²°ê³¼');
    sheet.getRange('A1:K1').setValues([[
      'ì¶”ì²œì¼ì‹œ', 'ì§ì›ID', 'ì´ë¦„', 'ë¶€ì„œ', 'ì§ë¬´',
      'í•µì‹¬ í‚¤ì›Œë“œ', 'ì¶”ì²œ ì£¼ì œ', 'ê²€ìƒ‰ í‚¤ì›Œë“œ',
      'ê³¼ì • URL', 'YouTube ê²€ìƒ‰ì–´', 'YouTube URL'
    ]]).setFontWeight('bold').setBackground('#34a853').setFontColor('#ffffff');
  });

  createSheetIfNotExists(ss, 'íŠ¸ë Œë“œë¶„ì„', () => {
    const sheet = ss.getSheetByName('íŠ¸ë Œë“œë¶„ì„');
    sheet.getRange('A1:G1').setValues([[
      'ë¶„ì„ì¼ì‹œ', 'ì§ì›ID', 'ì´ë¦„', 'ë¶€ì„œ', 'ì§ë¬´',
      'í•µì‹¬ í‚¤ì›Œë“œ', 'ì¶”ì²œ í•™ìŠµ ì£¼ì œ'
    ]]).setFontWeight('bold').setBackground('#fbbc04').setFontColor('#ffffff');
  });
}
function createSheetIfNotExists(ss, name, setup) {
  if (!ss.getSheetByName(name)) {
    ss.insertSheet(name);
    setup();
  }
}
// ========================================
// 8. ìºì‹œ ë° ë°ì´í„° ì´ˆê¸°í™” (v3.8ì—ì„œ í†µí•©)
// ========================================
function clearCache() {
  CACHE.removeAll(['trend_']);
  SpreadsheetApp.getUi().alert('âœ… ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function clearResults() {
  const ui = SpreadsheetApp.getUi();
  if (ui.alert('ğŸ—‘ï¸ ê²°ê³¼ ë°ì´í„° ì‚­ì œ', 'ì¶”ì²œê²°ê³¼ì™€ íŠ¸ë Œë“œë¶„ì„ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', ui.ButtonSet.YES_NO) !== ui.Button.YES) {
    return;
  }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = [CONFIG.SHEETS.RESULT, CONFIG.SHEETS.TREND];
  sheets.forEach(name => {
    const sheet = ss.getSheetByName(name);
    if (sheet) {
      sheet.getDataRange().clearContent();
      initializeSheets();  // í—¤ë” ì¬ìƒì„±
    }
  });
  ui.alert('âœ… ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function showHelp() {
  SpreadsheetApp.getUi().alert('â“ ë„ì›€ë§', 'ì´ ì‹œìŠ¤í…œì€ Gemini AIë¥¼ ì´ìš©í•œ êµìœ¡ ì¶”ì²œì…ë‹ˆë‹¤.\n- ì´ˆê¸° ì„¤ì •: API í‚¤ ì…ë ¥\n- ì„ íƒí•œ ì§ì› ì¶”ì²œ: Aì—´ ì²´í¬ë°•ìŠ¤ ì„ íƒ í›„ ì‹¤í–‰', SpreadsheetApp.getUi().ButtonSet.OK);
}
