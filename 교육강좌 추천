/**
 * ========================================
 * Gemini AI ê¸°ë°˜ êµìœ¡ ì¶”ì²œ ì‹œìŠ¤í…œ v3.9.6
 * ========================================
 *
 * ì£¼ìš” ìˆ˜ì • ì‚¬í•­ (v3.9.5 â†’ v3.9.6):
 * - í”„ë¡¬í”„íŠ¸ ìˆ˜ì •
 * - gemma-3-12bë¡œ ìˆ˜ì •
 */
// ========================================
// 1. ì„¤ì • ë° ìƒìˆ˜
// ========================================
const CONFIG = {
  GEMINI_API_KEY: PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY'),
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemma-3-12b-it:generateContent',

  MAX_RETRIES: 5,
  BASE_DELAY: 1000,
  CACHE_HOURS: 6,
  BATCH_SIZE: 3,
  PROCESS_DELAY: 5000,

  SHEETS: {
    EMPLOYEE: 'ì§ì›ì •ë³´',
    TREND: 'íŠ¸ë Œë“œë¶„ì„',
    RESULT: 'ì¶”ì²œê²°ê³¼'
  }
};
// ========================================
// 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ========================================
const Utils = {
  log(category, message, data = null) {
    const timestamp = new Date().toISOString();
    let logMessage = `[${timestamp}] [${category}] ${message}`;
    if (data) {
      try {
        logMessage += '\n' + JSON.stringify(data, null, 2);
      } catch (e) {
        logMessage += '\n' + String(data);
      }
    }
    console.log(logMessage);
  },
  sleep(ms) {
    Utilities.sleep(ms);
  },
  isValidUrl(url) {
    if (!url || typeof url !== 'string') return false;
    const urlPattern = /^https?:\/\/.+/i;
    if (!urlPattern.test(url)) return false;
    const invalidPatterns = [
      /javascript:/i,
      /<script/i,
      /void\(0\)/i
    ];
    return !invalidPatterns.some(pattern => pattern.test(url));
  },
  escapeHtml(text) {
    if (!text) return '';
    return text.toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  },
  extractJSON(text) {
    if (!text) return null;
   
    let jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try { return JSON.parse(jsonMatch[0]); } catch (e) {}
    }
   
    jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
    if (jsonMatch) {
      try { return JSON.parse(jsonMatch[1]); } catch (e) {}
    }
   
    jsonMatch = text.match(/```\s*([\s\S]*?)\s*```/);
    if (jsonMatch) {
      try { return JSON.parse(jsonMatch[1]); } catch (e) {}
    }
   
    const firstBrace = text.indexOf('{');
    const lastBrace = text.lastIndexOf('}');
    if (firstBrace !== -1 && lastBrace !== -1 && firstBrace < lastBrace) {
      try {
        return JSON.parse(text.substring(firstBrace, lastBrace + 1));
      } catch (e) {}
    }
   
    return null;
  }
};
// ========================================
// 3. Gemini API í˜¸ì¶œ
// ========================================
function callGeminiAPI(prompt, retryCount = 0) {
  const startTime = Date.now();
 
  if (!prompt || typeof prompt !== 'string') {
    Utils.log('API_ERROR', 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ í”„ë¡¬í”„íŠ¸', {
      promptType: typeof prompt,
      promptValue: prompt
    });
    throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ í”„ë¡¬í”„íŠ¸: ${typeof prompt}`);
  }
 
  if (prompt.trim().length === 0) {
    Utils.log('API_ERROR', 'âŒ ë¹ˆ í”„ë¡¬í”„íŠ¸');
    throw new Error('ë¹ˆ í”„ë¡¬í”„íŠ¸ëŠ” ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
 
  try {
    Utils.log('API_CALL', `Gemini API í˜¸ì¶œ ì‹œì‘ (ì‹œë„ ${retryCount + 1}/${CONFIG.MAX_RETRIES})`, {
      promptLength: prompt.length,
      promptPreview: prompt.substring(0, 200)
    });
    const response = UrlFetchApp.fetch(
      `${CONFIG.GEMINI_API_URL}?key=${CONFIG.GEMINI_API_KEY}`,
      {
        method: 'post',
        contentType: 'application/json',
        muteHttpExceptions: true,
        payload: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 2048
          }
        })
      }
    );
    const responseCode = response.getResponseCode();
    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
    if (responseCode === 429) {
      Utils.log('API_ERROR', `HTTP 429: API í• ë‹¹ëŸ‰ ì´ˆê³¼ (${duration}ì´ˆ ì†Œìš”)`);
      if (retryCount < CONFIG.MAX_RETRIES - 1) {
        const waitTime = 60;
        Utils.log('RETRY', `${waitTime}ì´ˆ í›„ ì¬ì‹œë„ (${retryCount + 2}/${CONFIG.MAX_RETRIES})`);
        Utils.sleep(waitTime * 1000);
        return callGeminiAPI(prompt, retryCount + 1);
      }
      throw new Error('API í• ë‹¹ëŸ‰ ì´ˆê³¼: 1ì‹œê°„ í›„ ì¬ì‹œë„í•˜ê±°ë‚˜ API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    }
    if (responseCode === 503) {
      Utils.log('API_ERROR', `HTTP 503: ì„œë²„ ê³¼ë¶€í•˜ (${duration}ì´ˆ ì†Œìš”)`);
      if (retryCount < CONFIG.MAX_RETRIES - 1) {
        const delay = CONFIG.BASE_DELAY * Math.pow(2, retryCount);
        Utils.log('RETRY', `${delay}ms í›„ ì¬ì‹œë„ (${retryCount + 2}/${CONFIG.MAX_RETRIES})`);
        Utils.sleep(delay);
        return callGeminiAPI(prompt, retryCount + 1);
      }
      throw new Error('ì„œë²„ ê³¼ë¶€í•˜: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    }
    if (responseCode !== 200) {
      throw new Error(`API ì˜¤ë¥˜ (HTTP ${responseCode}): ${response.getContentText()}`);
    }
    const result = JSON.parse(response.getContentText());
    const content = result?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!content) {
      throw new Error('API ì‘ë‹µì— í…ìŠ¤íŠ¸ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    Utils.log('API_SUCCESS', `âœ… ì‘ë‹µ ìˆ˜ì‹  (${duration}ì´ˆ ì†Œìš”)`, {
      contentLength: content.length,
      contentPreview: content.substring(0, 200)
    });
    return content;
  } catch (error) {
    Utils.log('API_ERROR', `âŒ ì‹¤íŒ¨: ${error.message}`, {
      stack: error.stack,
      retryCount: retryCount
    });
    if (retryCount < CONFIG.MAX_RETRIES - 1) {
      const delay = CONFIG.BASE_DELAY * Math.pow(2, retryCount);
      Utils.log('RETRY', `${delay}ms í›„ ì¬ì‹œë„ (${retryCount + 2}/${CONFIG.MAX_RETRIES})`);
      Utils.sleep(delay);
      return callGeminiAPI(prompt, retryCount + 1);
    }
    throw error;
  }
}
// ========================================
// 4. ì§ì› ë°ì´í„° íŒŒì‹±
// ========================================
function parseEmployees() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEETS.EMPLOYEE);
  const data = sheet.getDataRange().getValues();
 
  if (data.length < 2) {
    Utils.log('PARSE', 'âŒ ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return [];
  }
  const headers = data[0];
  Utils.log('PARSE', '=== í—¤ë” í™•ì¸ ===', { headers: headers });
  const columnIndex = {
    selected: headers.indexOf('ì„ íƒ'),
    id: headers.indexOf('ì§ì›ID'),
    name: headers.indexOf('ì´ë¦„'),
    email: headers.indexOf('ì´ë©”ì¼'),
    jobRole: headers.indexOf('ì§ë¬´'),
    department: headers.indexOf('ë¶€ì„œ'),
    careerYears: headers.indexOf('ê²½ë ¥(ë…„)'),
    skills: headers.indexOf('ì£¼ìš” ì—­ëŸ‰'),
    goals: headers.indexOf('ëª©í‘œ ì—­ëŸ‰'),
    budget: headers.indexOf('ì˜ˆì‚°(ë§Œì›)'),
    preference: headers.indexOf('ì„ í˜¸ ë°©ì‹'),
    status: headers.indexOf('ìƒíƒœ')
  };
  Utils.log('PARSE', '=== ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘ ===', columnIndex);
  if (columnIndex.selected === -1) {
    Utils.log('PARSE', 'âŒ "ì„ íƒ" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    throw new Error('ì‹œíŠ¸ì— "ì„ íƒ" ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.');
  }
  if (columnIndex.jobRole === -1) {
    Utils.log('PARSE', 'âŒ "ì§ë¬´" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    throw new Error('ì‹œíŠ¸ì— "ì§ë¬´" ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.');
  }
  const employees = [];
  Utils.log('PARSE', `=== ì§ì› ë°ì´í„° íŒŒì‹± ì‹œì‘ (ì´ ${data.length - 1}í–‰) ===`);
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
   
    if (row[columnIndex.selected] !== true) {
      Utils.log('PARSE', `â­ï¸ ê±´ë„ˆëœ€: ${row[columnIndex.name] || '(ì´ë¦„ ì—†ìŒ)'} - ì„ íƒë˜ì§€ ì•ŠìŒ`);
      continue;
    }
    const employee = {
      id: row[columnIndex.id],
      name: row[columnIndex.name],
      email: row[columnIndex.email],
      jobRole: row[columnIndex.jobRole],
      department: row[columnIndex.department],
      careerYears: row[columnIndex.careerYears],
      skills: row[columnIndex.skills],
      goals: row[columnIndex.goals],
      budget: row[columnIndex.budget],
      preference: row[columnIndex.preference],
      status: row[columnIndex.status],
      selected: row[columnIndex.selected]
    };
    if (!employee.name || !employee.email || !employee.jobRole) {
      Utils.log('PARSE', `âš ï¸ ê±´ë„ˆëœ€: í–‰ ${i + 1} - í•„ìˆ˜ ì •ë³´ ëˆ„ë½`, {
        name: employee.name,
        email: employee.email,
        jobRole: employee.jobRole
      });
      continue;
    }
    employees.push(employee);
   
    Utils.log('PARSE', `âœ… ì§ì› ì¶”ê°€: ${employee.name} (${employee.department})`, {
      id: employee.id,
      jobRole: employee.jobRole,
      rowIndex: i + 1
    });
  }
  Utils.log('PARSE', `=== íŒŒì‹± ì™„ë£Œ: ${employees.length}ëª… ì„ íƒë¨ ===`);
  return employees;
}
// ========================================
// 5. íŠ¸ë Œë“œ ë¶„ì„ ì‹œíŠ¸ í—¤ë” ë³´ì¥
// ========================================
function ensureTrendSheetHeader() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(CONFIG.SHEETS.TREND);
  
  if (!sheet) {
    sheet = ss.insertSheet(CONFIG.SHEETS.TREND);
  }
  
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      'ë¶„ì„ì¼ì‹œ',
      'ì§ì›ID',
      'ì´ë¦„',
      'ë¶€ì„œ',
      'ì§ë¬´',
      'í•µì‹¬ í‚¤ì›Œë“œ',
      'ì¶”ì²œ í•™ìŠµ ì£¼ì œ'
    ]);
    sheet.getRange('A1:G1').setFontWeight('bold').setBackground('#fbbc04').setFontColor('#ffffff');
    Utils.log('TREND_SHEET', 'âœ… íŠ¸ë Œë“œë¶„ì„ ì‹œíŠ¸ í—¤ë” ìƒì„± ì™„ë£Œ');
  }
}
// ========================================
// 6. íŠ¸ë Œë“œ ë¶„ì„
// ========================================
function analyzeTrend(employee) {
  Utils.log('TREND_ANALYZE', `=== íŠ¸ë Œë“œ ë¶„ì„ ì‹œì‘: ${employee.name} ===`);
  if (!employee || !employee.jobRole) {
    Utils.log('TREND_ANALYZE', 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì§ì› ë°ì´í„°');
    throw new Error('ì§ì› ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }
  const cache = CacheService.getScriptCache();
  const cacheKey = `trend_${employee.jobRole}`;
  const cached = cache.get(cacheKey);
  if (cached) {
    Utils.log('TREND_ANALYZE', `âœ… ìºì‹œ ë¡œë“œ: ${employee.jobRole}`);
    const trendData = JSON.parse(cached);
    try {
      saveTrend(employee, trendData);
    } catch (e) {}
    return trendData;
  }
  const prompt = `
ë‹¹ì‹ ì€ ${employee.jobRole} ë¶„ì•¼ì˜ ìµœì‹  íŠ¸ë Œë“œë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
**ë¶„ì„ ëŒ€ìƒ:**
- ì§ë¬´: ${employee.jobRole}
- ë¶€ì„œ: ${employee.department}
- ê²½ë ¥: ${employee.careerYears}ë…„
- ì£¼ìš” ì—­ëŸ‰: ${employee.skills}
- ëª©í‘œ ì—­ëŸ‰: ${employee.goals}
**ìš”ì²­ì‚¬í•­:**
1. 2025-2026ë…„ ${employee.jobRole} ë¶„ì•¼ì˜ í•µì‹¬ íŠ¸ë Œë“œ 5ê°€ì§€ë¥¼ ë¶„ì„í•˜ì„¸ìš”.
2. ê° íŠ¸ë Œë“œì— ëŒ€í•œ ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì œì‹œí•˜ì„¸ìš”.
3. ì‹¤ë¬´ì— ì ìš© ê°€ëŠ¥í•œ í•™ìŠµ ì£¼ì œ 3ê°€ì§€ë¥¼ ì¶”ì²œí•˜ì„¸ìš”.
**ì¶œë ¥ í˜•ì‹ (JSON):**
{
  "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", "í‚¤ì›Œë“œ4", "í‚¤ì›Œë“œ5"],
  "topics": ["ì£¼ì œ1", "ì£¼ì œ2", "ì£¼ì œ3"]
}
ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
`;
  const response = callGeminiAPI(prompt);
  const trendData = Utils.extractJSON(response);
  if (!trendData || !trendData.keywords || !trendData.topics) {
    Utils.log('TREND_ANALYZE', 'âŒ JSON íŒŒì‹± ì‹¤íŒ¨', { response: response });
    throw new Error('íŠ¸ë Œë“œ ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  cache.put(cacheKey, JSON.stringify(trendData), CONFIG.CACHE_HOURS * 3600);
  try {
    saveTrend(employee, trendData);
  } catch (e) {}
  return trendData;
}
// ========================================
// 7. ê³¼ì • ì¶”ì²œ (Geminiê°€ ì§ì ‘ ì‹¤ì œ ê³¼ì • + URL ì¶”ì²œ)
// ========================================
function recommendCourses(employee, trendData) {
  Utils.log('COURSE_RECOMMEND', `=== ê³¼ì • ì¶”ì²œ ì‹œì‘: ${employee.name} ===`);
  
  const prompt = `
ë‹¹ì‹ ì€ ìµœê³ ì˜ êµìœ¡ ê³¼ì • íë ˆì´í„°ì…ë‹ˆë‹¤. 
**ì§ì› ì •ë³´:**
- ì´ë¦„: ${employee.name}
- ì§ë¬´: ${employee.jobRole}
- ê²½ë ¥: ${employee.careerYears}ë…„
- ì£¼ìš” ì—­ëŸ‰: ${employee.skills}
- ëª©í‘œ ì—­ëŸ‰: ${employee.goals}
**íŠ¸ë Œë“œ ë¶„ì„ ê²°ê³¼:**
- í•µì‹¬ í‚¤ì›Œë“œ: ${trendData.keywords.join(', ')}
- ì¶”ì²œ í•™ìŠµ ì£¼ì œ: ${trendData.topics.join(', ')}

**ìš”ì²­ì‚¬í•­:**
ìœ„ íŠ¸ë Œë“œ í‚¤ì›Œë“œì™€ í•™ìŠµ ì£¼ì œë¥¼ ê°€ì¥ ì˜ ë°˜ì˜í•˜ëŠ” êµìœ¡ ê³¼ì • 5ê°œë¥¼ ì§ì ‘ ì°¾ì•„ ì¶”ì²œí•´ì£¼ì„¸ìš”.
- ê²€ìƒ‰ëœ ëª¨ë“  ê°•ì¢Œ ì¤‘ì— ì¡°íšŒìˆ˜/ìˆ˜ê°•ìƒ ë§ê³  í‰ì  ë†’ì€ ê³¼ì • ìš°ì„ 
- ê° ê³¼ì •ì˜ ì •í™•í•œ ê³¼ì • í˜ì´ì§€ URLì„ ë°˜ë“œì‹œ í¬í•¨

**ì¶œë ¥ í˜•ì‹ (JSON):**
{
  "courses": [
    {
      "site": "í”Œë«í¼ëª… (ì˜ˆ: Udemy)",
      "title": "ì •í™•í•œ ê³¼ì •ëª…",
      "url": "https://ì‹¤ì œê³¼ì •í˜ì´ì§€URL",
      "reason": "ì¶”ì²œ ì´ìœ  (íŠ¸ë Œë“œ/ì£¼ì œ ì¼ì¹˜ë„, í‰ì , ì¸ê¸° ë“±)"
    },
    {
      "site": "í”Œë«í¼ëª…",
      "title": "ì •í™•í•œ ê³¼ì •ëª…",
      "url": "https://ì‹¤ì œê³¼ì •í˜ì´ì§€URL",
      "reason": "ì¶”ì²œ ì´ìœ "
    },
    {
      "site": "í”Œë«í¼ëª…",
      "title": "ì •í™•í•œ ê³¼ì •ëª…",
      "url": "https://ì‹¤ì œê³¼ì •í˜ì´ì§€URL",
      "reason": "ì¶”ì²œ ì´ìœ "
    }
  ]
}
ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ê³ , URLì€ ìœ íš¨ì„±ì´ ìˆëŠ” í˜ì´ì§€ì—¬ì•¼ í•©ë‹ˆë‹¤.
`;
  const response = callGeminiAPI(prompt);
  const result = Utils.extractJSON(response);
  
  if (!result || !result.courses || result.courses.length === 0) {
    Utils.log('COURSE_RECOMMEND', 'âŒ ì¶”ì²œ ì‹¤íŒ¨ - ë¹ˆ ê²°ê³¼');
    return { courses: [] };
  }
  
  // URL ìœ íš¨ì„± ê²€ì‚¬ (ì˜ëª»ëœ URLì€ ë¹ˆ ë¬¸ìì—´ë¡œ)
  const validCourses = result.courses.map(course => ({
    ...course,
    url: Utils.isValidUrl(course.url) ? course.url : ''
  }));
  
  Utils.log('COURSE_RECOMMEND', `âœ… ê³¼ì • ì¶”ì²œ ì™„ë£Œ: ${validCourses.length}ê°œ`);
  return { courses: validCourses };
}
// ========================================
// 8. YouTube ì¶”ì²œ (ì¡°íšŒìˆ˜ ë†’ì€ ì˜ìƒ ìš°ì„ )
// ========================================
function recommendYouTube(employee, trendData) {
  Utils.log('YOUTUBE_RECOMMEND', `=== YouTube ì¶”ì²œ ì‹œì‘: ${employee.name} ===`);
  
  const prompt = `
ë‹¹ì‹ ì€ ìµœê³ ì˜ êµìœ¡ ì˜ìƒ íë ˆì´í„°ì…ë‹ˆë‹¤. ì•„ë˜ ì •ë³´ë¥¼ ì°¸ê³ í•´ì„œ YouTube ì˜ìƒì„ ì°¾ì•„ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤.
**ì§ì› ì •ë³´:**
- ì§ë¬´: ${employee.jobRole}
- ëª©í‘œ ì—­ëŸ‰: ${employee.goals}
**íŠ¸ë Œë“œ í‚¤ì›Œë“œ:** ${trendData.keywords.join(', ')}
**ì¶”ì²œ í•™ìŠµ ì£¼ì œ:** ${trendData.topics.join(', ')}

**ìš”ì²­ì‚¬í•­:**
ìœ„ í‚¤ì›Œë“œì™€ ì£¼ì œ, ëª©í‘œ ì—­ëŸ‰ì˜ ë‹¨ì–´ë“¤ê³¼ ì—°ê´€ìˆëŠ” YouTube ì˜ìƒ 5ê°œë¥¼ ì§ì ‘ ì°¾ì•„ ì¶”ì²œí•´ì£¼ì„¸ìš”.
- ì œëª©ì´ë‚˜ ì„¤ëª…ì— íŠ¸ë Œë“œ í‚¤ì›Œë“œë‚˜ ëª©í‘œ ì—­ëŸ‰ ê´€ë ¨ ë‹¨ì–´ê°€ í¬í•¨ëœ ì˜ìƒ ìš°ì„ 
- ì¡°íšŒìˆ˜ê°€ ë†’ê³  ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì´ ë§ì€ ì˜ìƒ ì„ íƒ
- ê° ì˜ìƒì˜ ì •í™•í•œ watch í˜ì´ì§€ URLì„ ë°˜ë“œì‹œ í¬í•¨

**ì¶œë ¥ í˜•ì‹ (JSON):**
{
  "videos": [
    {
      "title": "ì •í™•í•œ ì˜ìƒ ì œëª©",
      "url": "https://www.youtube.com/watch?v=XXXXX",
      "reason": "ì¶”ì²œ ì´ìœ  (í‚¤ì›Œë“œ í¬í•¨, ì¡°íšŒìˆ˜, ì±„ë„ ì‹ ë¢°ë„ ë“±)"
    },
    ...
  ]
}
ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ê³ , URLì€ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì˜ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.
`;
  const response = callGeminiAPI(prompt);
  const result = Utils.extractJSON(response);
  
  if (!result || !result.videos || result.videos.length === 0) {
    Utils.log('YOUTUBE_RECOMMEND', 'âŒ ì¶”ì²œ ì‹¤íŒ¨ - ë¹ˆ ê²°ê³¼');
    return [];
  }
  
  // URL ìœ íš¨ì„± ê²€ì‚¬
  const validVideos = result.videos.map(video => ({
    ...video,
    url: Utils.isValidUrl(video.url) && video.url.includes('youtube.com/watch') ? video.url : ''
  }));
  
  Utils.log('YOUTUBE_RECOMMEND', `âœ… YouTube ì¶”ì²œ ì™„ë£Œ: ${validVideos.length}ê°œ`);
  return validVideos;
}
// ========================================
// 9. íŠ¸ë Œë“œ ë¶„ì„ ì €ì¥
// ========================================
function saveTrend(employee, trendData) {
  ensureTrendSheetHeader();
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEETS.TREND);
  const timestamp = new Date();
  
  sheet.appendRow([
    timestamp,
    employee.id || '',
    employee.name || '',
    employee.department || '',
    employee.jobRole || '',
    trendData.keywords.join(', '),
    trendData.topics.join('\n')
  ]);
  
  Utils.log('TREND_SAVE', `âœ… ì €ì¥ ì™„ë£Œ: ${employee.name}`);
}
// ========================================
// 10. ì´ë©”ì¼ ë°œì†¡
// ========================================
function sendEmail(employee, trendData, courses, youtubeVideos) {
  Utils.log('EMAIL', `=== ì´ë©”ì¼ ë°œì†¡ ì‹œì‘: ${employee.email} ===`);
  
  const coursesHtml = courses.map((course, index) => `
    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
      <h3 style="color: #2c3e50; margin: 0 0 10px 0;">
        ${index + 1}. ${Utils.escapeHtml(course.title)}
      </h3>
      <p style="margin: 5px 0; color: #7f8c8d;">
        <strong>ì œê³µ:</strong> ${Utils.escapeHtml(course.site)}
      </p>
      <p style="margin: 5px 0; color: #34495e;">
        <strong>ì¶”ì²œ ì´ìœ :</strong> ${Utils.escapeHtml(course.reason)}
      </p>
      <p style="margin: 10px 0 0 0;">
        ${course.url ? 
          `<a href="${course.url}" style="display: inline-block; padding: 8px 16px; background: #3498db; color: white; text-decoration: none; border-radius: 4px;">
            ğŸ¯ ë°”ë¡œ ìˆ˜ê°•í•˜ê¸°
          </a>` : 
          '<span style="color: #95a5a6;">URL í™•ì¸ ë¶ˆê°€</span>'
        }
      </p>
    </div>
  `).join('');
  
  const youtubeHtml = youtubeVideos.map((video, index) => `
    <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px;">
      <h4 style="color: #856404; margin: 0 0 8px 0;">
        ${index + 1}. ${Utils.escapeHtml(video.title)}
      </h4>
      <p style="margin: 5px 0; color: #856404;">
        <strong>ì¶”ì²œ ì´ìœ :</strong> ${Utils.escapeHtml(video.reason)}
      </p>
      <p style="margin: 10px 0 0 0;">
        ${video.url ? 
          `<a href="${video.url}" style="display: inline-block; padding: 8px 16px; background: #ff0000; color: white; text-decoration: none; border-radius: 4px;">
            â–¶ï¸ ë°”ë¡œ ë³´ê¸°
          </a>` : 
          '<span style="color: #95a5a6;">URL í™•ì¸ ë¶ˆê°€</span>'
        }
      </p>
    </div>
  `).join('');
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
      <h1 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px;">
        ğŸ“ ${employee.name}ë‹˜ì„ ìœ„í•œ ë§ì¶¤ êµìœ¡ ì¶”ì²œ
      </h1>
     
      <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h2 style="color: #16a085; margin-top: 0;">ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„ ê²°ê³¼</h2>
        <p><strong>í•µì‹¬ í‚¤ì›Œë“œ:</strong> ${trendData.keywords.join(', ')}</p>
        <p><strong>ì¶”ì²œ í•™ìŠµ ì£¼ì œ:</strong></p>
        <ul>
          ${trendData.topics.map(topic => `<li>${Utils.escapeHtml(topic)}</li>`).join('')}
        </ul>
      </div>
      
      <h2 style="color: #16a085; margin-top: 30px;">ğŸ’¡ ì¶”ì²œ êµìœ¡ ê³¼ì •</h2>
      ${coursesHtml || '<p>ì¶”ì²œ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
      
      <h2 style="color: #d68910; margin-top: 30px;">ğŸ¬ ì¶”ì²œ YouTube ì˜ìƒ</h2>
      ${youtubeHtml || '<p>ì¶”ì²œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
      
      <div style="margin-top: 40px; padding: 15px; background: #ecf0f1; border-radius: 8px; text-align: center;">
        <p style="color: #7f8c8d; margin: 0;">
          ë³¸ ì¶”ì²œì€ Gemini AIê°€ ${new Date().toLocaleDateString('ko-KR')} ê¸°ì¤€ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
        </p>
        <p style="color: #95a5a6; margin: 5px 0 0 0; font-size: 12px;">
          â€» AIê°€ ì§ì ‘ ì„ ì •í•œ ì‹¤ì œ ê³¼ì •/ì˜ìƒ í˜ì´ì§€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  `;
  
  try {
    MailApp.sendEmail({
      to: employee.email,
      subject: `[êµìœ¡ ì¶”ì²œ] ${employee.name}ë‹˜ì„ ìœ„í•œ ë§ì¶¤ í•™ìŠµ ê³¼ì •`,
      htmlBody: htmlBody
    });
    Utils.log('EMAIL', `âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ: ${employee.email}`);
    return true;
  } catch (error) {
    Utils.log('EMAIL', `âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${error.message}`);
    return false;
  }
}
// ========================================
// 11. ê²°ê³¼ ì €ì¥
// ========================================
function saveResult(employee, trendData, courses, youtubeVideos) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEETS.RESULT);
  if (!sheet) return;
  
  const timestamp = new Date();
  const courseTitles = courses.map(c => c.title).join('\n');
  const courseUrls = courses.map(c => c.url).join('\n');
  const youtubeTitles = youtubeVideos.map(v => v.title).join('\n');
  const youtubeUrls = youtubeVideos.map(v => v.url).join('\n');
  
  sheet.appendRow([
    timestamp,
    employee.id,
    employee.name,
    employee.department,
    employee.jobRole,
    trendData.keywords.join(', '),
    trendData.topics.join(', '),
    courseTitles,
    courseUrls,
    youtubeTitles,
    youtubeUrls
  ]);
}
// ========================================
// 12. ë©”ì¸ ì²˜ë¦¬ í•¨ìˆ˜
// ========================================
function processEmployees() {
  const startTime = Date.now();
  Utils.log('PROCESS', '=== êµìœ¡ ì¶”ì²œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ===');
  try {
    const employees = parseEmployees();
    if (employees.length === 0) {
      SpreadsheetApp.getUi().alert('ì²˜ë¦¬í•  ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš” (Aì—´ ì²´í¬ë°•ìŠ¤).');
      return;
    }
    if (employees.length > CONFIG.BATCH_SIZE) {
      SpreadsheetApp.getUi().alert(`í•œ ë²ˆì— ìµœëŒ€ ${CONFIG.BATCH_SIZE}ëª…ê¹Œì§€ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
      return;
    }
    
    let successCount = 0;
    let failCount = 0;
    
    for (let i = 0; i < employees.length; i++) {
      const employee = employees[i];
      try {
        const trendData = analyzeTrend(employee);
        const { courses } = recommendCourses(employee, trendData);
        const youtubeVideos = recommendYouTube(employee, trendData);
        const emailSent = sendEmail(employee, trendData, courses, youtubeVideos);
        if (emailSent) {
          saveResult(employee, trendData, courses, youtubeVideos);
          successCount++;
        } else {
          failCount++;
        }
      } catch (error) {
        failCount++;
        Utils.log('PROCESS', `âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${employee.name}`, { error: error.message });
      }
      if (i < employees.length - 1) {
        Utils.sleep(CONFIG.PROCESS_DELAY);
      }
    }
    
    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
    const summary = `ì²˜ë¦¬ ì™„ë£Œ\nì´ ì‹œê°„: ${duration}ì´ˆ\nì„±ê³µ: ${successCount}ëª…\nì‹¤íŒ¨: ${failCount}ëª…`;
    SpreadsheetApp.getUi().alert(summary);
  } catch (error) {
    SpreadsheetApp.getUi().alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
  }
}
// ========================================
// 13. ë©”ë‰´ ë° ì´ˆê¸° ì„¤ì •
// ========================================
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ğŸ“ êµìœ¡ ì¶”ì²œ ì‹œìŠ¤í…œ')
    .addItem('â–¶ï¸ ì„ íƒí•œ ì§ì› ì²˜ë¦¬', 'processEmployees')
    .addSeparator()
    .addItem('âš™ï¸ API í‚¤ ì„¤ì •', 'showApiKeyDialog')
    .addItem('ğŸ—‘ï¸ ìºì‹œ ì´ˆê¸°í™”', 'clearCache')
    .addToUi();
}
function showApiKeyDialog() {
  const ui = SpreadsheetApp.getUi();
  const currentKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  const message = currentKey
    ? 'API í‚¤ê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nìƒˆë¡œìš´ í‚¤ë¥¼ ì…ë ¥í•˜ë©´ êµì²´ë©ë‹ˆë‹¤.'
    : 'Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(https://aistudio.google.com/apikey ì—ì„œ ë°œê¸‰)';
 
  const response = ui.prompt('API í‚¤ ì„¤ì •', message, ui.ButtonSet.OK_CANCEL);
 
  if (response.getSelectedButton() === ui.Button.OK) {
    const apiKey = response.getResponseText().trim();
    if (apiKey) {
      PropertiesService.getScriptProperties().setProperty('GEMINI_API_KEY', apiKey);
      ui.alert('âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      ui.alert('âŒ ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    }
  }
}
function clearCache() {
  CacheService.getScriptCache().removeAll(['trend_']);
  SpreadsheetApp.getUi().alert('âœ… ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
