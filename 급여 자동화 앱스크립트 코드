/**
 * ====================================
 * ê¸‰ì—¬ ìë™í™” ì‹œìŠ¤í…œ v3.0 (ìµœì í™”)
 * ====================================
 **/

// ==================== ì„¤ì • ====================
const CONFIG = {
  SLACK_WEBHOOK_URL: 'YOUR_SLACK_WEBHOOK_URL',
  HR_EMAIL: 'YOUR_EMAIL',
  SHEET_NAMES: ['ì§ì›ì •ë³´', 'ê¸‰ì—¬ê³„ì‚°', 'ì „ì›”ê¸‰ì—¬', 'ì„¤ì •ê°’', 'ì´ìƒì¹˜ë¡œê·¸', 'ëŒ€ì‹œë³´ë“œ'],
  COLORS: {
    PRIMARY: '#4285f4',
    SUCCESS: '#34a853',
    WARNING: '#fbbc04',
    ERROR: '#ea4335',
    INFO: '#00acc1',
    ACCENT: '#9c27b0'
  }
};

// ==================== 1. ì´ˆê¸° ì„¤ì • ====================
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ğŸ’¼ ê¸‰ì—¬ê´€ë¦¬')
    .addItem('ğŸ”§ ì´ˆê¸°ì„¤ì •', 'initialSetup')
    .addItem('ğŸ’° ê¸‰ì—¬ê³„ì‚°', 'executePayrollWorkflow')
    .addItem('ğŸ“§ ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡', 'sendPayslips')
    .addItem('ğŸ”„ ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨', 'refreshDashboard')
    .addSeparator()
    .addItem('ğŸ’¾ ì „ì›” ë°ì´í„° ì €ì¥', 'saveLastMonthData')
    .addItem('â° ì›”ê°„ ìë™ì‹¤í–‰ ì„¤ì •', 'setupMonthlyTrigger')
    .addToUi();
  
  showToast('ê¸‰ì—¬ê´€ë¦¬ ì‹œìŠ¤í…œì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'âœ… ì¤€ë¹„ì™„ë£Œ', 3);
}

function initialSetup() {
  showToast('ì´ˆê¸° ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'â³ ì‹¤í–‰ ì¤‘', -1);
  
  try {
    createAllSheets();
    setupSheetHeaders();
    setupSettingsData();
    setupDashboard();
    finalizeSetup();
    
    showToast(
      'ëª¨ë“  ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nì§ì›ì •ë³´ ì‹œíŠ¸ì— ë°ì´í„°ë¥¼ ì…ë ¥í•œ í›„ "ê¸‰ì—¬ê³„ì‚°"ì„ ì‹¤í–‰í•˜ì„¸ìš”.',
      'âœ… ì´ˆê¸°ì„¤ì • ì™„ë£Œ',
      5
    );
  } catch (error) {
    handleError('ì´ˆê¸°ì„¤ì •', error);
  }
}

function createAllSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  CONFIG.SHEET_NAMES.forEach(name => {
    if (!ss.getSheetByName(name)) {
      ss.insertSheet(name);
      Logger.log(`${name} ì‹œíŠ¸ ìƒì„± ì™„ë£Œ`);
    }
  });
}

function setupSheetHeaders() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ì§ì›ì •ë³´ ì‹œíŠ¸
  setupEmployeeSheet(ss.getSheetByName('ì§ì›ì •ë³´'));
  
  // ê¸‰ì—¬ê³„ì‚° ì‹œíŠ¸
  setupPayrollSheet(ss.getSheetByName('ê¸‰ì—¬ê³„ì‚°'));
  
  // ì „ì›”ê¸‰ì—¬ ì‹œíŠ¸
  setupLastMonthSheet(ss.getSheetByName('ì „ì›”ê¸‰ì—¬'));
  
  // ì´ìƒì¹˜ë¡œê·¸ ì‹œíŠ¸
  setupOutlierSheet(ss.getSheetByName('ì´ìƒì¹˜ë¡œê·¸'));
}

function setupEmployeeSheet(sheet) {
  sheet.clear();
  const headers = ['ì‚¬ë²ˆ', 'ì´ë©”ì¼', 'ì´ë¦„', 'ë¶€ì„œ', 'ì§ê¸‰', 'ê¸°ë³¸ê¸‰', 'ì…ì‚¬ì¼', 'ë¶€ì–‘ê°€ì¡±ìˆ˜', 'ê³„ì¢Œë²ˆí˜¸', 'ì•¼ê·¼ì‹œê°„'];
  
  setSheetHeader(sheet, headers, CONFIG.COLORS.PRIMARY);
  sheet.setColumnWidth(2, 200); // ì´ë©”ì¼ ì—´
  
  // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
  const lastRow = 100;
  setNumberValidation(sheet, 2, 10, lastRow); // ì•¼ê·¼ì‹œê°„
  setNumberValidation(sheet, 2, 8, lastRow);  // ë¶€ì–‘ê°€ì¡±ìˆ˜
}

function setupPayrollSheet(sheet) {
  sheet.clear();
  const headers = [
    'ì‚¬ë²ˆ', 'ì´ë©”ì¼', 'ì´ë¦„', 'ë¶€ì„œ', 'ì§ê¸‰', 'ê¸°ë³¸ê¸‰', 'ì‹ëŒ€', 'êµí†µë¹„', 'ì•¼ê·¼ìˆ˜ë‹¹', 
    'ì„¸ì „ê¸‰ì—¬', 'êµ­ë¯¼ì—°ê¸ˆ', 'ê±´ê°•ë³´í—˜', 'ì¥ê¸°ìš”ì–‘', 'ê³ ìš©ë³´í—˜', 'ì†Œë“ì„¸', 
    'ì´ê³µì œ', 'ì‹¤ìˆ˜ë ¹ì•¡', 'ì „ì›”ëŒ€ë¹„', 'ì¦ê°ë¥ (%)', 'ìƒíƒœ', 'ë¹„ê³ ', 'ì²˜ë¦¬ì¼ì‹œ', 'ì¼í• ê³„ì‚°'
  ];
  
  setSheetHeader(sheet, headers, CONFIG.COLORS.SUCCESS);
  sheet.setColumnWidth(2, 200); // ì´ë©”ì¼ ì—´
}

function setupLastMonthSheet(sheet) {
  sheet.clear();
  const headers = ['ì´ë¦„', 'ì‹¤ìˆ˜ë ¹ì•¡', 'ì €ì¥ì¼ì‹œ'];
  setSheetHeader(sheet, headers, CONFIG.COLORS.WARNING);
}

function setupOutlierSheet(sheet) {
  sheet.clear();
  const headers = ['íƒì§€ì¼ì‹œ', 'ì‚¬ë²ˆ', 'ì´ë¦„', 'ë¶€ì„œ', 'ì‹¤ìˆ˜ë ¹ì•¡', 'ìƒíƒœ', 'ì‚¬ìœ ', 'ì „ì›”ëŒ€ë¹„'];
  setSheetHeader(sheet, headers, CONFIG.COLORS.ERROR);
}

function setupSettingsData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ì„¤ì •ê°’');
  sheet.clear();
  
  const headers = ['í•­ëª©', 'ê°’', 'ë¹„ê³ '];
  const data = [
    ['ì‹ëŒ€', 200000, 'ì›” ê³ ì •'],
    ['êµí†µë¹„', 200000, 'ì›” ê³ ì •'],
    ['ì•¼ê·¼ìˆ˜ë‹¹_ì‹œê°„ë‹¹', 15000, ''],
    ['êµ­ë¯¼ì—°ê¸ˆ_ìš”ìœ¨', 0.045, '4.5%'],
    ['ê±´ê°•ë³´í—˜_ìš”ìœ¨', 0.03545, '3.545%'],
    ['ì¥ê¸°ìš”ì–‘_ìš”ìœ¨', 0.1295, 'ê±´ê°•ë³´í—˜ì˜ 12.95%'],
    ['ê³ ìš©ë³´í—˜_ìš”ìœ¨', 0.009, '0.9%'],
    ['ì´ìƒì¹˜_ê¸°ì¤€_ë°°ìœ¨', 0.08, 'ì „ì›” ëŒ€ë¹„ 8% ë³€ë™'],
    ['ìµœì €ì‹¤ìˆ˜ë ¹ì•¡_ê¸°ì¤€', 2156880, '']
  ];
  
  setSheetHeader(sheet, headers, CONFIG.COLORS.ACCENT);
  sheet.getRange(2, 1, data.length, 3).setValues(data);
  sheet.setColumnWidths(1, 3, 200);
}

function setupDashboard() {
  const dashboard = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ëŒ€ì‹œë³´ë“œ');
  dashboard.clear();
  
  // ì œëª©
  const titleRange = dashboard.getRange('A1:F1');
  titleRange.merge()
    .setValue('ğŸ“Š ê¸‰ì—¬ ê³„ì‚° ëŒ€ì‹œë³´ë“œ')
    .setFontSize(18)
    .setFontWeight('bold')
    .setBackground(CONFIG.COLORS.PRIMARY)
    .setFontColor('#ffffff');
  
  // ê¸°ë³¸ í†µê³„
  setupDashboardSection(dashboard, 'A3', 'ğŸ“ˆ ê¸°ë³¸ í†µê³„', CONFIG.COLORS.SUCCESS, [
    ['ì´ ì§ì› ìˆ˜', "=COUNTA(ê¸‰ì—¬ê³„ì‚°!A2:A)"],
    ['ì´ ì§€ê¸‰ì•¡', '=SUM(ê¸‰ì—¬ê³„ì‚°!Q2:Q)'],
    ['í‰ê·  ì‹¤ìˆ˜ë ¹ì•¡', '=AVERAGE(ê¸‰ì—¬ê³„ì‚°!Q2:Q)'],
    ['ìµœê³  ì‹¤ìˆ˜ë ¹ì•¡', '=MAX(ê¸‰ì—¬ê³„ì‚°!Q2:Q)'],
    ['ìµœì € ì‹¤ìˆ˜ë ¹ì•¡', '=MIN(ê¸‰ì—¬ê³„ì‚°!Q2:Q)']
  ]);
  
  // ì´ìƒì¹˜ í˜„í™©
  setupDashboardSection(dashboard, 'A10', 'ğŸš¨ ì´ìƒì¹˜ í˜„í™©', CONFIG.COLORS.ERROR, [
    ['ê²½ê³  ê±´ìˆ˜', '=COUNTIF(ê¸‰ì—¬ê³„ì‚°!T2:T,"ğŸš¨ ê²½ê³ ")'],
    ['ì£¼ì˜ ê±´ìˆ˜', '=COUNTIF(ê¸‰ì—¬ê³„ì‚°!T2:T,"âš ï¸ ì£¼ì˜")'],
    ['ì •ìƒ ê±´ìˆ˜', '=COUNTIF(ê¸‰ì—¬ê³„ì‚°!T2:T,"âœ… ì •ìƒ")']
  ]);
  
  // ìƒìœ„/í•˜ìœ„ 5ëª…
  setupDashboardRankings(dashboard);
  
  // ë¶€ì„œë³„ í‰ê· 
  setupDashboardDepartment(dashboard);
  
  // ì—´ ë„ˆë¹„ ì¡°ì •
  [1, 4].forEach(col => dashboard.setColumnWidth(col, 180));
  [2, 5, 6].forEach(col => dashboard.setColumnWidth(col, 150));
}

function setupDashboardSection(sheet, startCell, title, color, data) {
  const row = parseInt(startCell.match(/\d+/)[0]);
  const col = startCell.charCodeAt(0) - 64;
  
  sheet.getRange(row, col, 1, 2)
    .merge()
    .setValue(title)
    .setFontWeight('bold')
    .setBackground(color)
    .setFontColor('#ffffff');
  
  sheet.getRange(row + 1, col, data.length, 2).setValues(data);
  sheet.getRange(row + 1, col + 1, data.length, 1).setNumberFormat('#,##0');
}

function setupDashboardRankings(sheet) {
  // ìƒìœ„ 5ëª…
  sheet.getRange('D3:F3')
    .merge()
    .setValue('ğŸ† ìƒìœ„ 5ëª… (ì‹¤ìˆ˜ë ¹ì•¡)')
    .setFontWeight('bold')
    .setBackground(CONFIG.COLORS.WARNING);
  
  sheet.getRange('D4:F4')
    .setValues([['ì´ë¦„', 'ë¶€ì„œ', 'ì‹¤ìˆ˜ë ¹ì•¡']])
    .setFontWeight('bold')
    .setBackground('#fce5cd');
  
  sheet.getRange('D5')
    .setFormula('=QUERY(ê¸‰ì—¬ê³„ì‚°!C2:Q, "SELECT C, D, Q WHERE Q > 0 ORDER BY Q DESC LIMIT 5", 0)');
  
  // í•˜ìœ„ 5ëª…
  sheet.getRange('D10:F10')
    .merge()
    .setValue('ğŸ“‰ í•˜ìœ„ 5ëª… (ì‹¤ìˆ˜ë ¹ì•¡)')
    .setFontWeight('bold')
    .setBackground(CONFIG.COLORS.ACCENT)
    .setFontColor('#ffffff');
  
  sheet.getRange('D11:F11')
    .setValues([['ì´ë¦„', 'ë¶€ì„œ', 'ì‹¤ìˆ˜ë ¹ì•¡']])
    .setFontWeight('bold')
    .setBackground('#d9d2e9');
  
  sheet.getRange('D12')
    .setFormula('=QUERY(ê¸‰ì—¬ê³„ì‚°!C2:Q, "SELECT C, D, Q WHERE Q > 0 ORDER BY Q ASC LIMIT 5", 0)');
}

function setupDashboardDepartment(sheet) {
  sheet.getRange('A16:B16')
    .merge()
    .setValue('ğŸ¢ ë¶€ì„œë³„ í‰ê·  ì‹¤ìˆ˜ë ¹ì•¡')
    .setFontWeight('bold')
    .setBackground(CONFIG.COLORS.INFO)
    .setFontColor('#ffffff');
  
  sheet.getRange('A17:B17')
    .setValues([['ë¶€ì„œ', 'í‰ê·  ì‹¤ìˆ˜ë ¹ì•¡']])
    .setFontWeight('bold')
    .setBackground('#b2dfdb');
  
  sheet.getRange('A18')
    .setFormula('=QUERY(ê¸‰ì—¬ê³„ì‚°!D2:Q, "SELECT D, AVG(Q) WHERE Q > 0 GROUP BY D ORDER BY AVG(Q) DESC LABEL D \'ë¶€ì„œ\', AVG(Q) \'í‰ê·  ì‹¤ìˆ˜ë ¹ì•¡\'", 1)');
}

function finalizeSetup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  CONFIG.SHEET_NAMES.forEach(name => {
    const sheet = ss.getSheetByName(name);
    if (sheet) sheet.setFrozenRows(1);
  });
  Logger.log('ì´ˆê¸°ì„¤ì • ì™„ë£Œ');
}

// ==================== 2. ê¸‰ì—¬ê³„ì‚° ì›Œí¬í”Œë¡œìš° ====================
function executePayrollWorkflow() {
  try {
    const steps = [
      { name: 'ê¸‰ì—¬ê³„ì‚°', func: executePayroll, message: 'ê¸‰ì—¬ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...' },
      { name: 'ì´ìƒì¹˜íƒì§€', func: detectOutliers, message: 'ì´ìƒì¹˜ë¥¼ íƒì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤...' },
      { name: 'Slackì•Œë¦¼', func: sendSlackNotification, message: 'Slack ì•Œë¦¼ì„ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...', conditional: true },
      { name: 'ëª…ì„¸ì„œë°œì†¡', func: sendPayslips, message: 'ê¸‰ì—¬ëª…ì„¸ì„œë¥¼ ë°œì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...' }
    ];
    
    let calculationResult, outliers, emailResult;
    
    for (let i = 0; i < steps.length; i++) {
      const step = steps[i];
      showToast(`${i + 1}/${steps.length} ë‹¨ê³„: ${step.message}`, 'â³ ì‹¤í–‰ ì¤‘', -1);
      
      if (step.name === 'ê¸‰ì—¬ê³„ì‚°') {
        calculationResult = step.func();
        if (!calculationResult.success) throw new Error(calculationResult.message);
      } else if (step.name === 'ì´ìƒì¹˜íƒì§€') {
        outliers = step.func();
      } else if (step.name === 'Slackì•Œë¦¼' && outliers && outliers.length > 0) {
        step.func(outliers);
      } else if (step.name === 'ëª…ì„¸ì„œë°œì†¡') {
        emailResult = step.func();
      }
      
      SpreadsheetApp.flush();
      Utilities.sleep(1000);
    }
    
    refreshDashboard();
    showWorkflowResult(calculationResult, outliers, emailResult);
    
  } catch (error) {
    handleError('ê¸‰ì—¬ê³„ì‚° ì›Œí¬í”Œë¡œìš°', error);
  }
}

function executePayroll() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const employeeSheet = ss.getSheetByName('ì§ì›ì •ë³´');
    const payrollSheet = ss.getSheetByName('ê¸‰ì—¬ê³„ì‚°');
    
    const lastRow = employeeSheet.getLastRow();
    if (lastRow < 2) return { success: false, message: 'ì§ì›ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', count: 0 };
    
    const employeeData = employeeSheet.getRange(2, 1, lastRow - 1, 10).getValues();
    const settings = getSettings();
    const results = [];
    
    employeeData.forEach(row => {
      const employee = parseEmployeeData(row);
      if (!employee.ì‚¬ë²ˆ || !employee.ì´ë¦„) return;
      
      const payroll = calculatePayroll(employee, settings);
      results.push(Object.values(payroll));
    });
    
    // ê²°ê³¼ ì €ì¥
    payrollSheet.getRange(2, 1, payrollSheet.getMaxRows() - 1, 23).clearContent();
    if (results.length > 0) {
      payrollSheet.getRange(2, 1, results.length, 23).setValues(results);
      payrollSheet.getRange(2, 6, results.length, 15).setNumberFormat('#,##0');
      payrollSheet.getRange(2, 19, results.length, 1).setNumberFormat('0.00');
    }
    
    applyConditionalFormatting();
    return { success: true, message: 'ê¸‰ì—¬ ê³„ì‚° ì™„ë£Œ', count: results.length };
    
  } catch (error) {
    Logger.log('ê¸‰ì—¬ê³„ì‚° ì˜¤ë¥˜: ' + error.message);
    return { success: false, message: error.message, count: 0 };
  }
}

function parseEmployeeData(row) {
  return {
    ì‚¬ë²ˆ: row[0],
    ì´ë©”ì¼: row[1],
    ì´ë¦„: row[2],
    ë¶€ì„œ: row[3],
    ì§ê¸‰: row[4],
    ê¸°ë³¸ê¸‰: row[5],
    ì…ì‚¬ì¼: row[6],
    ë¶€ì–‘ê°€ì¡±ìˆ˜: row[7],
    ê³„ì¢Œë²ˆí˜¸: row[8],
    ì•¼ê·¼ì‹œê°„: row[9]
  };
}

function calculatePayroll(employee, settings) {
  // ì¼í• ê³„ì‚°
  const prorata = calculateProrata(employee.ì…ì‚¬ì¼);
  
  // ê¸‰ì—¬ í•­ëª© ê³„ì‚°
  const ì ìš©_ê¸°ë³¸ê¸‰ = Math.round(employee.ê¸°ë³¸ê¸‰ * prorata.ë¹„ìœ¨);
  const ì ìš©_ì‹ëŒ€ = Math.round(settings.ì‹ëŒ€ * prorata.ë¹„ìœ¨);
  const ì ìš©_êµí†µë¹„ = Math.round(settings.êµí†µë¹„ * prorata.ë¹„ìœ¨);
  const ì•¼ê·¼ìˆ˜ë‹¹ = employee.ì•¼ê·¼ì‹œê°„ * settings.ì•¼ê·¼ìˆ˜ë‹¹_ì‹œê°„ë‹¹;
  const ì„¸ì „ê¸‰ì—¬ = ì ìš©_ê¸°ë³¸ê¸‰ + ì ìš©_ì‹ëŒ€ + ì ìš©_êµí†µë¹„ + ì•¼ê·¼ìˆ˜ë‹¹;
  
  // ê³µì œ ê³„ì‚°
  const deductions = calculateDeductions(ì ìš©_ê¸°ë³¸ê¸‰, employee.ë¶€ì–‘ê°€ì¡±ìˆ˜, settings);
  const ì‹¤ìˆ˜ë ¹ì•¡ = ì„¸ì „ê¸‰ì—¬ - deductions.ì´ê³µì œ;
  
  // ì „ì›” ë¹„êµ
  const comparison = compareWithLastMonth(employee.ì´ë¦„, ì‹¤ìˆ˜ë ¹ì•¡, settings.ìµœì €ì‹¤ìˆ˜ë ¹ì•¡_ê¸°ì¤€);
  
  return {
    ì‚¬ë²ˆ: employee.ì‚¬ë²ˆ,
    ì´ë©”ì¼: employee.ì´ë©”ì¼,
    ì´ë¦„: employee.ì´ë¦„,
    ë¶€ì„œ: employee.ë¶€ì„œ,
    ì§ê¸‰: employee.ì§ê¸‰,
    ê¸°ë³¸ê¸‰: ì ìš©_ê¸°ë³¸ê¸‰,
    ì‹ëŒ€: ì ìš©_ì‹ëŒ€,
    êµí†µë¹„: ì ìš©_êµí†µë¹„,
    ì•¼ê·¼ìˆ˜ë‹¹: ì•¼ê·¼ìˆ˜ë‹¹,
    ì„¸ì „ê¸‰ì—¬: ì„¸ì „ê¸‰ì—¬,
    ...deductions,
    ì‹¤ìˆ˜ë ¹ì•¡: ì‹¤ìˆ˜ë ¹ì•¡,
    ...comparison,
    ì²˜ë¦¬ì¼ì‹œ: new Date(),
    ì¼í• ê³„ì‚°: prorata.ë©”ì‹œì§€
  };
}

function calculateDeductions(ê¸°ë³¸ê¸‰, ë¶€ì–‘ê°€ì¡±ìˆ˜, settings) {
  const êµ­ë¯¼ì—°ê¸ˆ = Math.round(ê¸°ë³¸ê¸‰ * settings.êµ­ë¯¼ì—°ê¸ˆ_ìš”ìœ¨);
  const ê±´ê°•ë³´í—˜ = Math.round(ê¸°ë³¸ê¸‰ * settings.ê±´ê°•ë³´í—˜_ìš”ìœ¨);
  const ì¥ê¸°ìš”ì–‘ = Math.round(ê±´ê°•ë³´í—˜ * settings.ì¥ê¸°ìš”ì–‘_ìš”ìœ¨);
  const ê³ ìš©ë³´í—˜ = Math.round(ê¸°ë³¸ê¸‰ * settings.ê³ ìš©ë³´í—˜_ìš”ìœ¨);
  const ì†Œë“ì„¸ = calculateIncomeTax(ê¸°ë³¸ê¸‰, ë¶€ì–‘ê°€ì¡±ìˆ˜);
  
  return {
    êµ­ë¯¼ì—°ê¸ˆ: êµ­ë¯¼ì—°ê¸ˆ,
    ê±´ê°•ë³´í—˜: ê±´ê°•ë³´í—˜,
    ì¥ê¸°ìš”ì–‘: ì¥ê¸°ìš”ì–‘,
    ê³ ìš©ë³´í—˜: ê³ ìš©ë³´í—˜,
    ì†Œë“ì„¸: ì†Œë“ì„¸,
    ì´ê³µì œ: êµ­ë¯¼ì—°ê¸ˆ + ê±´ê°•ë³´í—˜ + ì¥ê¸°ìš”ì–‘ + ê³ ìš©ë³´í—˜ + ì†Œë“ì„¸
  };
}

function compareWithLastMonth(ì´ë¦„, ì‹¤ìˆ˜ë ¹ì•¡, ìµœì €ê¸°ì¤€) {
  const ì „ì›”ë°ì´í„° = getLastMonthSalary(ì´ë¦„);
  let ì „ì›”ëŒ€ë¹„ = 0, ì¦ê°ë¥  = 0, ìƒíƒœ = 'âœ… ì •ìƒ', ë¹„ê³  = '-';
  
  if (ì „ì›”ë°ì´í„° && ì „ì›”ë°ì´í„° > 0) {
    ì „ì›”ëŒ€ë¹„ = ì‹¤ìˆ˜ë ¹ì•¡ - ì „ì›”ë°ì´í„°;
    ì¦ê°ë¥  = parseFloat(((ì „ì›”ëŒ€ë¹„ / ì „ì›”ë°ì´í„°) * 100).toFixed(2));
    
    if (ì‹¤ìˆ˜ë ¹ì•¡ < ì „ì›”ë°ì´í„°) {
      const ê°ì†Œìœ¨ = Math.abs(ì¦ê°ë¥ );
      if (ê°ì†Œìœ¨ > 8) {
        ìƒíƒœ = 'ğŸš¨ ê²½ê³ ';
        ë¹„ê³  = `ì „ì›”ë³´ë‹¤ ${ê°ì†Œìœ¨.toFixed(2)}% ë‚®ìŒ`;
      } else if (ê°ì†Œìœ¨ > 0) {
        ìƒíƒœ = 'âš ï¸ ì£¼ì˜';
        ë¹„ê³  = `ì „ì›”ë³´ë‹¤ ${ê°ì†Œìœ¨.toFixed(2)}% ë‚®ìŒ`;
      }
    }
  }
  
  if (ì‹¤ìˆ˜ë ¹ì•¡ < ìµœì €ê¸°ì¤€) {
    ìƒíƒœ = 'ğŸš¨ ê²½ê³ ';
    ë¹„ê³  = `ìµœì €ì‹¤ìˆ˜ë ¹ì•¡(${ìµœì €ê¸°ì¤€.toLocaleString()}ì›) ë¯¸ë‹¬`;
  }
  
  return { ì „ì›”ëŒ€ë¹„, ì¦ê°ë¥ , ìƒíƒœ, ë¹„ê³  };
}

function calculateProrata(ì…ì‚¬ì¼) {
  if (!ì…ì‚¬ì¼ || !(ì…ì‚¬ì¼ instanceof Date)) {
    return { ë¹„ìœ¨: 1.0, ë©”ì‹œì§€: '-' };
  }
  
  const ì˜¤ëŠ˜ = new Date();
  const ì…ì‚¬ë…„ = ì…ì‚¬ì¼.getFullYear();
  const ì…ì‚¬ì›” = ì…ì‚¬ì¼.getMonth();
  const ì…ì‚¬ì¼ì = ì…ì‚¬ì¼.getDate();
  
  if (ì…ì‚¬ë…„ === ì˜¤ëŠ˜.getFullYear() && ì…ì‚¬ì›” === ì˜¤ëŠ˜.getMonth()) {
    const ë§ì¼ = new Date(ì˜¤ëŠ˜.getFullYear(), ì˜¤ëŠ˜.getMonth() + 1, 0).getDate();
    const ê·¼ë¬´ì¼ìˆ˜ = ë§ì¼ - ì…ì‚¬ì¼ì + 1;
    const ë¹„ìœ¨ = ê·¼ë¬´ì¼ìˆ˜ / ë§ì¼;
    
    return {
      ë¹„ìœ¨: ë¹„ìœ¨,
      ë©”ì‹œì§€: `${ê·¼ë¬´ì¼ìˆ˜}ì¼/${ë§ì¼}ì¼ (${ì…ì‚¬ì¼ì}~${ë§ì¼}ì¼)`
    };
  }
  
  return { ë¹„ìœ¨: 1.0, ë©”ì‹œì§€: '-' };
}

function calculateIncomeTax(ê¸°ë³¸ê¸‰, ë¶€ì–‘ê°€ì¡±ìˆ˜ = 1) {
  const ê³µì œê¸ˆì•¡ = 150000 * ë¶€ì–‘ê°€ì¡±ìˆ˜;
  const ê³¼ì„¸í‘œì¤€ = Math.max(0, ê¸°ë³¸ê¸‰ - ê³µì œê¸ˆì•¡);
  
  if (ê³¼ì„¸í‘œì¤€ <= 1200000) return Math.round(ê³¼ì„¸í‘œì¤€ * 0.06);
  if (ê³¼ì„¸í‘œì¤€ <= 4600000) return Math.round(72000 + (ê³¼ì„¸í‘œì¤€ - 1200000) * 0.15);
  if (ê³¼ì„¸í‘œì¤€ <= 8800000) return Math.round(582000 + (ê³¼ì„¸í‘œì¤€ - 4600000) * 0.24);
  return Math.round(1590000 + (ê³¼ì„¸í‘œì¤€ - 8800000) * 0.35);
}

function getSettings() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ì„¤ì •ê°’');
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
  
  const settings = {};
  data.forEach(row => {
    settings[row[0]] = row[1];
  });
  return settings;
}

function getSetting(key) {
  const settings = getSettings();
  return settings[key] || null;
}

function getLastMonthSalary(ì´ë¦„) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ì „ì›”ê¸‰ì—¬');
  if (!sheet || sheet.getLastRow() < 2) return null;
  
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
  const row = data.find(r => r[0] === ì´ë¦„);
  return row ? row[1] : null;
}

function saveLastMonthData() {
  showToast('ì „ì›” ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤...', 'â³ ì‹¤í–‰ ì¤‘', -1);
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const payrollSheet = ss.getSheetByName('ê¸‰ì—¬ê³„ì‚°');
    const lastMonthSheet = ss.getSheetByName('ì „ì›”ê¸‰ì—¬');
    
    const lastRow = payrollSheet.getLastRow();
    if (lastRow < 2) throw new Error('ê¸‰ì—¬ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    
    const ì´ë¦„ = payrollSheet.getRange(2, 3, lastRow - 1, 1).getValues();
    const ì‹¤ìˆ˜ë ¹ì•¡ = payrollSheet.getRange(2, 17, lastRow - 1, 1).getValues();
    
    const saveData = ì´ë¦„
      .map((row, i) => row[0] ? [row[0], ì‹¤ìˆ˜ë ¹ì•¡[i][0], new Date()] : null)
      .filter(row => row !== null);
    
    lastMonthSheet.getRange(2, 1, lastMonthSheet.getMaxRows() - 1, 3).clearContent();
    if (saveData.length > 0) {
      lastMonthSheet.getRange(2, 1, saveData.length, 3).setValues(saveData);
      lastMonthSheet.getRange(2, 2, saveData.length, 1).setNumberFormat('#,##0');
    }
    
    showToast(`${saveData.length}ëª…ì˜ ì „ì›” ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'âœ… ì™„ë£Œ', 5);
    Logger.log(`ì „ì›” ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${saveData.length}ê±´`);
    
  } catch (error) {
    handleError('ì „ì›” ë°ì´í„° ì €ì¥', error);
  }
}

function applyConditionalFormatting() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ê¸‰ì—¬ê³„ì‚°');
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;
  
  const statusRange = sheet.getRange(2, 20, lastRow - 1, 1);
  statusRange.clearFormat();
  
  const rules = [
    { text: 'ê²½ê³ ', color: '#f4cccc' },
    { text: 'ì£¼ì˜', color: '#fff2cc' },
    { text: 'ì •ìƒ', color: '#d9ead3' }
  ].map(rule => 
    SpreadsheetApp.newConditionalFormatRule()
      .whenTextContains(rule.text)
      .setBackground(rule.color)
      .setRanges([statusRange])
      .build()
  );
  
  sheet.setConditionalFormatRules(rules);
}

// ==================== 3. ì´ìƒì¹˜ íƒì§€ ====================
function detectOutliers() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ê¸‰ì—¬ê³„ì‚°');
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];
    
    const data = sheet.getRange(2, 1, lastRow - 1, 21).getValues();
    const outliers = data
      .filter(row => row[19] && (row[19].includes('ê²½ê³ ') || row[19].includes('ì£¼ì˜')))
      .map(row => ({
        ì‚¬ë²ˆ: row[0],
        ì´ë¦„: row[2],
        ë¶€ì„œ: row[3],
        ì‹¤ìˆ˜ë ¹ì•¡: row[16],
        ìƒíƒœ: row[19],
        ë¹„ê³ : row[20],
        ì „ì›”ëŒ€ë¹„: row[17]
      }));
    
    if (outliers.length > 0) logOutliers(outliers);
    return outliers;
    
  } catch (error) {
    Logger.log('ì´ìƒì¹˜ íƒì§€ ì˜¤ë¥˜: ' + error.message);
    return [];
  }
}

function logOutliers(outliers) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ì´ìƒì¹˜ë¡œê·¸');
  const timestamp = new Date();
  
  const logs = outliers.map(o => [
    timestamp, o.ì‚¬ë²ˆ, o.ì´ë¦„, o.ë¶€ì„œ, o.ì‹¤ìˆ˜ë ¹ì•¡, o.ìƒíƒœ, o.ë¹„ê³ , o.ì „ì›”ëŒ€ë¹„
  ]);
  
  if (logs.length > 0) {
    sheet.getRange(sheet.getLastRow() + 1, 1, logs.length, 8).setValues(logs);
  }
}

function sendSlackNotification(outliers) {
  if (!CONFIG.SLACK_WEBHOOK_URL || outliers.length === 0) return;
  
  let message = 'ğŸš¨ *ê¸‰ì—¬ ì´ìƒì¹˜ íƒì§€ ì•Œë¦¼*\n\n';
  message += `ì´ ${outliers.length}ê±´ì˜ ì´ìƒì¹˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
  
  outliers.forEach(o => {
    message += `â€¢ *${o.ì´ë¦„}* (${o.ë¶€ì„œ}) - ${o.ìƒíƒœ}\n`;
    message += `  ì‹¤ìˆ˜ë ¹ì•¡: ${o.ì‹¤ìˆ˜ë ¹ì•¡.toLocaleString()}ì›\n`;
    message += `  ì‚¬ìœ : ${o.ë¹„ê³ }\n`;
    message += `  ì „ì›”ëŒ€ë¹„: ${o.ì „ì›”ëŒ€ë¹„ >= 0 ? '+' : ''}${o.ì „ì›”ëŒ€ë¹„.toLocaleString()}ì›\n\n`;
  });
  
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ text: message })
  };
  
  try {
    UrlFetchApp.fetch(CONFIG.SLACK_WEBHOOK_URL, options);
    Logger.log('Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ');
  } catch (error) {
    Logger.log('Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
  }
}

// ==================== 4. ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡ ====================
function sendPayslips() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ê¸‰ì—¬ê³„ì‚°');
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      showToast('ê¸‰ì—¬ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'âŒ ì˜¤ë¥˜', 5);
      return { success: 0, failed: 0 };
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 23).getValues();
    const ì²˜ë¦¬ë…„ì›” = Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyyë…„ MMì›”');
    
    let successCount = 0, failedCount = 0;
    
    data.forEach(row => {
      const result = sendPayslip(row, ì²˜ë¦¬ë…„ì›”);
      if (result) successCount++;
      else failedCount++;
    });
    
    Logger.log(`ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡ ì™„ë£Œ - ì„±ê³µ: ${successCount}ê±´, ì‹¤íŒ¨: ${failedCount}ê±´`);
    return { success: successCount, failed: failedCount };
    
  } catch (error) {
    handleError('ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡', error);
    return { success: 0, failed: 0 };
  }
}

function sendPayslip(row, ì²˜ë¦¬ë…„ì›”) {
  const [ì‚¬ë²ˆ, ì´ë©”ì¼, ì´ë¦„, ë¶€ì„œ, ì§ê¸‰, ê¸°ë³¸ê¸‰, ì‹ëŒ€, êµí†µë¹„, ì•¼ê·¼ìˆ˜ë‹¹,
         ì„¸ì „ê¸‰ì—¬, êµ­ë¯¼ì—°ê¸ˆ, ê±´ê°•ë³´í—˜, ì¥ê¸°ìš”ì–‘, ê³ ìš©ë³´í—˜, ì†Œë“ì„¸,
         ì´ê³µì œ, ì‹¤ìˆ˜ë ¹ì•¡, ì „ì›”ëŒ€ë¹„, ì¦ê°ë¥ , ìƒíƒœ, ë¹„ê³ , ì²˜ë¦¬ì¼ì‹œ, ì¼í• ê³„ì‚°] = row;
  
  if (!ì´ë©”ì¼ || !ì´ë¦„) {
    Logger.log(`[${ì´ë¦„}] ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ì–´ ë°œì†¡ ê±´ë„ˆëœ€`);
    return false;
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ì´ë©”ì¼)) {
    Logger.log(`[${ì´ë¦„}] ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼: ${ì´ë©”ì¼}`);
    return false;
  }
  
  try {
    const htmlBody = generatePayslipHTML({
      ì²˜ë¦¬ë…„ì›”, ì‚¬ë²ˆ, ì´ë¦„, ë¶€ì„œ, ì§ê¸‰, ê¸°ë³¸ê¸‰, ì‹ëŒ€, êµí†µë¹„, ì•¼ê·¼ìˆ˜ë‹¹,
      ì„¸ì „ê¸‰ì—¬, êµ­ë¯¼ì—°ê¸ˆ, ê±´ê°•ë³´í—˜, ì¥ê¸°ìš”ì–‘, ê³ ìš©ë³´í—˜, ì†Œë“ì„¸,
      ì´ê³µì œ, ì‹¤ìˆ˜ë ¹ì•¡, ì „ì›”ëŒ€ë¹„, ì¦ê°ë¥ , ì¼í• ê³„ì‚°
    });
    
    MailApp.sendEmail({
      to: ì´ë©”ì¼,
      subject: `[ê¸‰ì—¬ëª…ì„¸ì„œ] ${ì²˜ë¦¬ë…„ì›”} - ${ì´ë¦„}ë‹˜`,
      htmlBody: htmlBody
    });
    
    Logger.log(`[${ì´ë¦„}] ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡ ì™„ë£Œ: ${ì´ë©”ì¼}`);
    return true;
    
  } catch (error) {
    Logger.log(`[${ì´ë¦„}] ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡ ì‹¤íŒ¨: ${error.message}`);
    return false;
  }
}

function generatePayslipHTML(data) {
  return `
    <html>
      <head>
        <style>
          body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 800px; margin: 0 auto; padding: 20px; }
          .header { background-color: #4285f4; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }
          .content { background-color: #f9f9f9; padding: 20px; border: 1px solid #ddd; }
          .section { margin-bottom: 20px; }
          .section-title { font-size: 18px; font-weight: bold; color: #4285f4; margin-bottom: 10px; border-bottom: 2px solid #4285f4; padding-bottom: 5px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; background-color: white; }
          th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
          th { background-color: #f0f0f0; font-weight: bold; }
          .amount { text-align: right; font-weight: bold; }
          .total-row { background-color: #e3f2fd; font-weight: bold; font-size: 16px; }
          .highlight { color: #d32f2f; }
          .positive { color: #388e3c; }
          .footer { text-align: center; padding: 20px; color: #777; font-size: 12px; }
          .notice-box { background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin-top: 20px; }
          .notice-title { font-weight: bold; color: #856404; margin-bottom: 10px; }
          .notice-list { margin: 0; padding-left: 20px; }
          .notice-list li { margin: 5px 0; color: #856404; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>ğŸ’° ê¸‰ì—¬ëª…ì„¸ì„œ</h1>
            <p>${data.ì²˜ë¦¬ë…„ì›”}</p>
          </div>
          
          <div class="content">
            <div class="section">
              <div class="section-title">ğŸ“‹ ì§ì› ì •ë³´</div>
              <table>
                <tr><th>ì‚¬ë²ˆ</th><td>${data.ì‚¬ë²ˆ}</td><th>ì´ë¦„</th><td>${data.ì´ë¦„}</td></tr>
                <tr><th>ë¶€ì„œ</th><td>${data.ë¶€ì„œ}</td><th>ì§ê¸‰</th><td>${data.ì§ê¸‰}</td></tr>
                ${data.ì¼í• ê³„ì‚° && data.ì¼í• ê³„ì‚° !== '-' ? `<tr><th colspan="2">ì¼í• ê³„ì‚°</th><td colspan="2" class="highlight">${data.ì¼í• ê³„ì‚°}</td></tr>` : ''}
              </table>
            </div>
            
            <div class="section">
              <div class="section-title">ğŸ’µ ì§€ê¸‰ ë‚´ì—­</div>
              <table>
                <tr><th>í•­ëª©</th><th class="amount">ê¸ˆì•¡</th></tr>
                <tr><td>ê¸°ë³¸ê¸‰</td><td class="amount">${data.ê¸°ë³¸ê¸‰.toLocaleString()}ì›</td></tr>
                <tr><td>ì‹ëŒ€</td><td class="amount">${data.ì‹ëŒ€.toLocaleString()}ì›</td></tr>
                <tr><td>êµí†µë¹„</td><td class="amount">${data.êµí†µë¹„.toLocaleString()}ì›</td></tr>
                <tr><td>ì•¼ê·¼ìˆ˜ë‹¹</td><td class="amount">${data.ì•¼ê·¼ìˆ˜ë‹¹.toLocaleString()}ì›</td></tr>
                <tr class="total-row"><td>ì„¸ì „ê¸‰ì—¬</td><td class="amount">${data.ì„¸ì „ê¸‰ì—¬.toLocaleString()}ì›</td></tr>
              </table>
            </div>
            
            <div class="section">
              <div class="section-title">â– ê³µì œ ë‚´ì—­</div>
              <table>
                <tr><th>í•­ëª©</th><th class="amount">ê¸ˆì•¡</th></tr>
                <tr><td>êµ­ë¯¼ì—°ê¸ˆ</td><td class="amount">${data.êµ­ë¯¼ì—°ê¸ˆ.toLocaleString()}ì›</td></tr>
                <tr><td>ê±´ê°•ë³´í—˜</td><td class="amount">${data.ê±´ê°•ë³´í—˜.toLocaleString()}ì›</td></tr>
                <tr><td>ì¥ê¸°ìš”ì–‘</td><td class="amount">${data.ì¥ê¸°ìš”ì–‘.toLocaleString()}ì›</td></tr>
                <tr><td>ê³ ìš©ë³´í—˜</td><td class="amount">${data.ê³ ìš©ë³´í—˜.toLocaleString()}ì›</td></tr>
                <tr><td>ì†Œë“ì„¸</td><td class="amount">${data.ì†Œë“ì„¸.toLocaleString()}ì›</td></tr>
                <tr class="total-row"><td>ì´ê³µì œ</td><td class="amount">${data.ì´ê³µì œ.toLocaleString()}ì›</td></tr>
              </table>
            </div>
            
            <div class="section">
              <div class="section-title">âœ… ì‹¤ìˆ˜ë ¹ì•¡</div>
              <table>
                <tr class="total-row">
                  <td>ì‹¤ìˆ˜ë ¹ì•¡</td>
                  <td class="amount" style="font-size: 20px; color: #1976d2;">${data.ì‹¤ìˆ˜ë ¹ì•¡.toLocaleString()}ì›</td>
                </tr>
                ${data.ì „ì›”ëŒ€ë¹„ !== 0 ? `
                <tr>
                  <td>ì „ì›” ëŒ€ë¹„</td>
                  <td class="amount ${data.ì „ì›”ëŒ€ë¹„ >= 0 ? 'positive' : 'highlight'}">
                    ${data.ì „ì›”ëŒ€ë¹„ >= 0 ? '+' : ''}${data.ì „ì›”ëŒ€ë¹„.toLocaleString()}ì› (${data.ì¦ê°ë¥  >= 0 ? '+' : ''}${data.ì¦ê°ë¥ }%)
                  </td>
                </tr>` : ''}
              </table>
            </div>
            
            <div class="notice-box">
              <div class="notice-title">ğŸ“Œ ê¸‰ì—¬ í•­ëª© ì•ˆë‚´</div>
              <ul class="notice-list">
                <li><strong>ì‹ëŒ€:</strong> ë¹„ê³¼ì„¸ í•œë„ 20ë§Œì›</li>
                <li><strong>êµí†µë¹„:</strong> ë¹„ê³¼ì„¸ í•œë„ 20ë§Œì›</li>
                <li><strong>ì•¼ê·¼ìˆ˜ë‹¹:</strong> ë‹¹ì›” ì•¼ê·¼ì‹œê°„ Ã— ì‹œê¸‰ì˜ 1.5ë°°</li>
              </ul>
            </div>
          </div>
          
          <div class="footer">
            <p>ë³¸ ê¸‰ì—¬ëª…ì„¸ì„œëŠ” ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <p>ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì¸ì‚¬íŒ€(${CONFIG.HR_EMAIL})ìœ¼ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”.</p>
            <p>ë°œì†¡ì¼ì‹œ: ${Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')}</p>
          </div>
        </div>
      </body>
    </html>
  `;
}

// ==================== 5. ëŒ€ì‹œë³´ë“œ & íŠ¸ë¦¬ê±° ====================
function refreshDashboard() {
  try {
    const dashboard = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ëŒ€ì‹œë³´ë“œ');
    const tempCell = dashboard.getRange('A1');
    const originalValue = tempCell.getValue();
    tempCell.setValue('ìƒˆë¡œê³ ì¹¨ ì¤‘...');
    SpreadsheetApp.flush();
    tempCell.setValue(originalValue);
    Logger.log('ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
  } catch (error) {
    Logger.log('ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜: ' + error.message);
  }
}

function setupMonthlyTrigger() {
  ScriptApp.getProjectTriggers()
    .filter(t => t.getHandlerFunction() === 'executePayrollWorkflow')
    .forEach(t => ScriptApp.deleteTrigger(t));
  
  ScriptApp.newTrigger('executePayrollWorkflow')
    .timeBased()
    .onMonthDay(25)
    .atHour(9)
    .create();
  
  showToast('ë§¤ì›” 25ì¼ ì˜¤ì „ 9ì‹œì— ìë™ ê¸‰ì—¬ê³„ì‚°ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'âœ… íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ', 5);
}

// ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
function showToast(message, title, timeout) {
  SpreadsheetApp.getActiveSpreadsheet().toast(message, title, timeout);
}

function handleError(context, error) {
  const message = `${context} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
  showToast(message, 'âŒ ì˜¤ë¥˜', 5);
  Logger.log(`${context} ì˜¤ë¥˜: ${error.message}\n${error.stack}`);
}

function showWorkflowResult(calculationResult, outliers, emailResult) {
  let message = `âœ… ê¸‰ì—¬ê³„ì‚° ì™„ë£Œ\n\n`;
  message += `ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:\n`;
  message += `â€¢ ì´ ì§ì›: ${calculationResult.count}ëª…\n`;
  message += `â€¢ ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡: ${emailResult.success}ê±´ ì„±ê³µ, ${emailResult.failed}ê±´ ì‹¤íŒ¨\n\n`;
  
  if (outliers && outliers.length > 0) {
    const ê²½ê³  = outliers.filter(o => o.ìƒíƒœ.includes('ê²½ê³ ')).length;
    const ì£¼ì˜ = outliers.filter(o => o.ìƒíƒœ.includes('ì£¼ì˜')).length;
    message += `âš ï¸ ì´ìƒì¹˜ íƒì§€:\n`;
    message += `â€¢ ê²½ê³ : ${ê²½ê³ }ê±´\n`;
    message += `â€¢ ì£¼ì˜: ${ì£¼ì˜}ê±´\n`;
    message += `â€¢ Slack ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
  } else {
    message += `âœ… ì´ìƒì¹˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n`;
  }
  
  message += `ëŒ€ì‹œë³´ë“œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
  showToast(message, 'âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ', 10);
}

function setSheetHeader(sheet, headers, color) {
  const range = sheet.getRange(1, 1, 1, headers.length);
  range.setValues([headers])
    .setFontWeight('bold')
    .setBackground(color)
    .setFontColor('#ffffff');
}

function setNumberValidation(sheet, startRow, column, rowCount) {
  sheet.getRange(startRow, column, rowCount, 1).setDataValidation(
    SpreadsheetApp.newDataValidation()
      .requireNumberGreaterThanOrEqualTo(0)
      .setAllowInvalid(false)
      .setHelpText('0 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”')
      .build()
  );
}
